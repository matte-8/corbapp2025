<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css">
  <style>
    .cal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
    .cal-dow{display:flex;justify-content:space-between;opacity:.7;font-size:12px;margin-bottom:4px}
    .cal-cell{
      aspect-ratio:1; display:flex; align-items:center; justify-content:center;
      border-radius:12px; border:1px solid var(--ring); background:#fff; position:relative;
    }
    .cal-cell.muted{opacity:.35}
    .cal-dot{position:absolute; bottom:6px; width:8px; height:8px; border-radius:999px}
    .legend {display:flex; gap:12px; align-items:center}
    .legend .i{display:inline-block;width:8px;height:8px;border-radius:999px;margin-right:6px}
    .match-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--ring)}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" style="color:#fff">‚Üê</a>
      <div class="title" style="font-weight:700;margin-left:8px">Calendario</div>
    </div>
    <div class="right">
      <a class="iconbtn" href="./admin.html" title="Admin">‚ü≥</a>
    </div>
  </header>

  <main class="container">

    <!-- CALENDARI -->
    <section class="card">
      <div class="cal-head">
        <div id="label1" style="font-weight:700">Mese</div>
        <div class="legend small">
          <span><span class="i" style="background:#6b0f1a"></span>Casa</span>
          <span><span class="i" style="background:#0ea5e9"></span>Trasferta</span>
        </div>
      </div>
      <div class="grid-2">
        <div>
          <div class="cal-dow"><span>Dom</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span></div>
          <div id="grid1" class="cal-grid"></div>
        </div>
        <div>
          <div id="label2" style="font-weight:700;margin-bottom:8px">Mese</div>
          <div class="cal-dow"><span>Dom</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span></div>
          <div id="grid2" class="cal-grid"></div>
        </div>
      </div>
    </section>

    <!-- LISTA PROSSIME PARTITE -->
    <section class="card">
      <h2 style="margin:0 0 8px 0">Prossime partite</h2>
      <div id="matchList"></div>
    </section>

  </main>

  <script type="module">
    import {get} from './data-store.js';

    const COLOR_HOME = '#6b0f1a';   // granata
    const COLOR_AWAY = '#0ea5e9';   // azzurro

    // Calendario: foglio con colonne: data, avversario, casa_fuori
    const raw = get('calendar') || [];
    const events = raw
      .map(r => ({
        date: parseDate(r.data),
        dayStr: r.data || '',
        opponent: r.avversario || '',
        homeAway: (r.casa_fuori || '').toLowerCase() // 'casa' / 'trasferta'
      }))
      .filter(e => e.date instanceof Date && !isNaN(+e.date));

    // --- Helpers ---
    function parseDate(s){
      // Prova ISO (YYYY-MM-DD) oppure DD/MM/YYYY
      if (!s) return null;
      if (/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00');
      const m = s.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (m){
        const d = +m[1], mo = +m[2]-1, y = (+m[3] < 100 ? 2000+ +m[3] : +m[3]);
        return new Date(y, mo, d);
      }
      const d = new Date(s);
      return isNaN(+d) ? null : d;
    }

    function monthLabel(d){
      return d.toLocaleDateString(undefined, {month:'long', year:'numeric'});
    }

    function firstDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth(), 1); }
    function lastDayOfMonth(d){ return new Date(d.getFullYear(), d.getMonth()+1, 0); }

    function marksForMonth(year, month){
      // restituisce { dayNumber: { home:true/false } }
      const marks = {};
      for (const e of events){
        if (e.date.getFullYear() === year && e.date.getMonth() === month){
          const day = e.date.getDate();
          marks[day] = { home: e.homeAway === 'casa' };
        }
      }
      return marks;
    }

    function buildCalendar(containerId, labelId, refDate){
      const container = document.getElementById(containerId);
      container.innerHTML = '';
      document.getElementById(labelId).textContent = monthLabel(refDate);

      const first = firstDayOfMonth(refDate);
      const last  = lastDayOfMonth(refDate);

      // Calcola offset partendo da Domenica (0)
      const startOffset = first.getDay(); // 0..6
      // Celle vuote prima
      for (let i=0; i<startOffset; i++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell muted';
        container.appendChild(cell);
      }

      const marks = marksForMonth(refDate.getFullYear(), refDate.getMonth());

      // Giorni del mese
      for (let day=1; day<=last.getDate(); day++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.textContent = day;

        if (marks[day]){
          const dot = document.createElement('span');
          dot.className = 'cal-dot';
          dot.style.background = marks[day].home ? COLOR_HOME : COLOR_AWAY;
          cell.appendChild(dot);
        }

        container.appendChild(cell);
      }
    }

    // --- Render due mesi (corrente + prossimo) ---
    const now = new Date();
    const thisMonth = new Date(now.getFullYear(), now.getMonth(), 1);
    const nextMonth = new Date(now.getFullYear(), now.getMonth()+1, 1);

    buildCalendar('grid1', 'label1', thisMonth);
    buildCalendar('grid2', 'label2', nextMonth);

    // --- Lista prossime partite ---
    const listEl = document.getElementById('matchList');
    const upcoming = events
      .filter(e => e.date >= new Date(new Date().setHours(0,0,0,0)))
      .sort((a,b) => +a.date - +b.date)
      .slice(0, 12); // mostra prossime 12

    function row(e){
      const icon = e.homeAway === 'casa' ? 'üè†' : '‚úàÔ∏è';
      const color = e.homeAway === 'casa' ? COLOR_HOME : COLOR_AWAY;
      const ds = e.date.toLocaleDateString(undefined, {weekday:'short', day:'2-digit', month:'short'});
      return `
        <div class="match-row">
          <div class="row">
            <span class="pill" style="border-color:${color};color:${color};background:transparent">${icon}</span>
            <div><div><strong>Corbiolo - ${e.opponent}</strong></div><div class="small">${ds}</div></div>
          </div>
        </div>`;
    }

    listEl.innerHTML = upcoming.length
      ? upcoming.map(row).join('')
      : '<div class="small">Nessuna partita in programma</div>';

    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }
  </script>
</body>
</html>
