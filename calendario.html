<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css?v=19">
  <style>
    :root{ --home:#6b0f1a; --away:#0ea5e9; }

    /* ----- Layout responsive calendario ----- */
    .month-wrap{margin-bottom:18px}
    .month-head{display:flex;align-items:center;justify-content:space-between}
    .month-name{font-weight:900;line-height:1.05;font-size:clamp(20px,6vw,28px)}
    .head-right{display:flex;gap:8px}
    .arrowbtn{border-radius:12px;border:1px solid var(--ring);background:#fff;padding:6px 10px}

    .legend{display:flex;gap:16px;align-items:center;margin-top:8px}
    .dot{width:10px;height:10px;border-radius:999px}
    .dot-home{background:var(--home)}
    .dot-away{background:var(--away)}

    .cal-dow{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;color:#6b6b6b;margin:10px 0 6px}
    .cal-grid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .cal-cell{
      border:1px solid var(--ring);border-radius:14px;background:#fff;
      display:flex;align-items:center;justify-content:center;
      aspect-ratio:1/1; font-weight:600;font-size:clamp(12px,3.6vw,16px)
    }
    .muted{opacity:.35}
    .has{color:#fff;box-shadow:0 2px 10px rgba(0,0,0,.12)}
    .home{background:var(--home)!important;border-color:var(--home)!important}
    .away{background:var(--away)!important;border-color:var(--away)!important}

    /* Lista future sotto */
    .future-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--ring)}
    .future-row:last-child{border-bottom:0}
    .home-pill{background:#f3e8eb;border:1px solid #e4cbd3;color:var(--home)}
    .away-pill{background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.35);color:var(--away)}

    /* Drawer (non blocca i click quando √® chiuso) */
    #drawer{
      position:fixed;top:0;right:-260px;width:240px;height:100%;background:#fff;
      box-shadow:-3px 0 12px rgba(0,0,0,.2);transition:.3s;padding:20px;z-index:1000;
      pointer-events:none;
    }
    #drawer.open{ right:0; pointer-events:auto; }
    #drawer a{display:block;padding:12px 0;border-bottom:1px solid var(--ring);color:var(--text)}
    #drawer-close{position:absolute;top:12px;right:12px;font-size:20px;cursor:pointer}
    .topbar{ z-index: 1100; }

    /* Badge logo squadre */
    .team-badge{width:28px;height:28px;border-radius:50%;overflow:hidden;border:2px solid #e8d3d9;background:#fff;flex:0 0 28px}
    .team-badge img{width:100%;height:100%;object-fit:cover;display:block}
    .team-line{display:flex;align-items:center;gap:8px}
    @media (max-width:380px){ .team-badge{width:24px;height:24px} }
  </style>
</head>
<body>
<!-- Topbar -->
<header class="topbar">
  <div class="nav">
    <a href="./index.html" class="brand">
      <img src="img/logo_c5.png" alt="Corbiolo" class="brand-logo">
      <span class="title">Home</span>
    </a>
  </div>
  <div class="right">
    <button data-role="menu-btn" class="iconbtn" aria-label="Menu" title="Menu">
      <!-- hamburger (solo 3 linee) -->
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none"
           stroke="#ffffff" stroke-width="2" stroke-linecap="round">
        <path d="M3 6h18M3 12h18M3 18h18"/>
      </svg>
    </button>
  </div>
</header>

<!-- Drawer menu (uguale per tutte le pagine) -->
<nav class="drawer" data-role="drawer">
  <button class="drawer-close" data-role="drawer-close" aria-label="Chiudi">‚úï</button>
  <h3>Menu</h3>
  <a href="./index.html">üè† Home</a>
  <a href="./news.html">üì∞ News</a>
  <a href="./squadra.html">üë• Squadra</a>
  <a href="./video.html">üé• Video</a>
  <a href="./prossima.html">üìÖ Prossima partita</a>
  <a href="./partite.html">üèÜ Risultati</a>
  <a href="./calendario.html">üìÜ Calendario</a>
  <a href="./admin.html">‚öôÔ∏è Admin</a>
</nav>

  <!-- Menu script (non modulo) -->
  <script>
    (function(){
      const drawer   = document.getElementById('drawer');
      const btn      = document.getElementById('menuBtn');
      const closeBtn = document.getElementById('drawer-close');
      if (btn) btn.addEventListener('click', (e)=>{ e.stopPropagation(); drawer.classList.add('open'); });
      if (closeBtn) closeBtn.addEventListener('click', ()=> drawer.classList.remove('open'));
      document.addEventListener('click', (e)=>{
        if (drawer.classList.contains('open') && !drawer.contains(e.target) && e.target!==btn) {
          drawer.classList.remove('open');
        }
      });
    })();
  </script>

  <main class="container">
    <section class="card month-wrap">
      <!-- TESTATA mese 1: frecce SOPRA, legenda SOTTO -->
      <div class="month-head">
        <div class="month-name" id="m1"></div>
        <div class="head-right">
          <button class="arrowbtn" id="prevM" title="Mese precedente">‚Üê</button>
          <button class="arrowbtn" id="nextM" title="Mese successivo">‚Üí</button>
        </div>
      </div>
      <div class="legend small">
        <span class="dot dot-home"></span> Casa
        <span class="dot dot-away" style="margin-left:12px"></span> Trasferta
      </div>

      <div class="cal-dow"><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span><span>Dom</span></div>
      <div id="grid1" class="cal-grid"></div>

      <!-- Spazio tra i mesi -->
      <div style="height:16px"></div>

      <!-- Mese 2 -->
      <div class="month-head">
        <div class="month-name" id="m2"></div>
        <div style="width:68px"></div><!-- placeholder per simmetria -->
      </div>
      <div class="cal-dow"><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span><span>Dom</span></div>
      <div id="grid2" class="cal-grid"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px 0">Prossime partite</h2>
      <div id="futureList"></div>
    </section>
  </main>

  <!-- Modulo SOLO per la logica del calendario -->
  <script type="module">
    import {get} from './data-store.js';

    // Helpers
    function toDate(d) {
      if (!d) return new Date('Invalid');
      if (/^\d{4}-\d{2}-\d{2}/.test(d)) return new Date(d);
      const m = d.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (m) { const dd=+m[1], mm=+m[2]-1, yy=(+m[3]<100?2000+ +m[3]:+m[3]); return new Date(yy,mm,dd); }
      return new Date(d);
    }
    const fmtMonth = (d) => d.toLocaleDateString(undefined,{month:'long',year:'numeric'});
    const daysInMonth = (y,m) => new Date(y, m+1, 0).getDate();
    // 0=Mon (Luned√¨-first)
    const startDowMon = (y,m) => (new Date(y,m,1).getDay()+6)%7;

    // === LOGHI ===
    const CORB = 'img/logo_c5.png';
    const AVV  = 'img/logo_avv.png';
    const isHome = m => (m.casa||'').trim().toLowerCase() === 'corbiolo';
    function teamLogo(m, side){
      if (side==='left'){
        const name = isHome(m) ? 'corbiolo' : String(m.casa||'').toLowerCase().trim();
        if (name==='corbiolo') return CORB;
        return m.logo_casa || AVV;
      } else {
        const name = isHome(m) ? String(m.fuori||'').toLowerCase().trim() : 'corbiolo';
        if (name==='corbiolo') return CORB;
        return m.logo_avv || m.logo_fuori || AVV;
      }
    }

    const calData = (get('calendar')||[]).map(r=>({
      date: toDate(r.data),
      avversario: r.avversario || '',
      casa_fuori: (r.casa_fuori||'').toLowerCase()
    })).filter(e=>!isNaN(+e.date));

    let offset = 0; // sposta finestra mesi

    function buildTwoMonths(){
      const base = new Date();
      const mA = new Date(base.getFullYear(), base.getMonth()+offset, 1);
      const mB = new Date(base.getFullYear(), base.getMonth()+offset+1, 1);
      buildMonth('grid1','m1', mA);
      buildMonth('grid2','m2', mB);
    }

    function buildMonth(gridId, labelId, baseDate){
      const y = baseDate.getFullYear(), m = baseDate.getMonth();
      document.getElementById(labelId).textContent = fmtMonth(baseDate);
      const grid = document.getElementById(gridId);
      grid.innerHTML = '';

      const leading = startDowMon(y,m);
      for(let i=0;i<leading;i++){
        const c = document.createElement('div');
        c.className = 'cal-cell muted';
        grid.appendChild(c);
      }

      const nDays = daysInMonth(y,m);
      for(let d=1; d<=nDays; d++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.textContent = d;

        const match = calData.find(e =>
          e.date.getFullYear()===y && e.date.getMonth()===m && e.date.getDate()===d
        );
        if (match){
          cell.classList.add('has');
          if (match.casa_fuori === 'casa') cell.classList.add('home');
          else cell.classList.add('away');
          cell.title = (match.casa_fuori==='casa' ? 'Corbiolo - ' : '') +
                       match.avversario +
                       (match.casa_fuori==='fuori' ? ' - Corbiolo' : '');
        }

        grid.appendChild(cell);
      }
    }

    // Frecce mesi (spostano di 1 mese la finestra)
    document.getElementById('prevM').addEventListener('click', ()=>{ offset -= 1; buildTwoMonths(); window.scrollTo({top:0,behavior:'smooth'}); });
    document.getElementById('nextM').addEventListener('click', ()=>{ offset += 1; buildTwoMonths(); window.scrollTo({top:0,behavior:'smooth'}); });

    buildTwoMonths();

    // ---- Lista future sotto (dalla tab partite) ----
    const matches = (get('matches')||[]).map(m=>({
      ...m,
      date: new Date((m.data||'')+'T'+(m.ora||'00:00'))
    })).filter(m=>!isNaN(+m.date));

    const now = new Date();
    const futures = matches.filter(m=> m.date > now).sort((a,b)=> a.date - b.date);

    function row(m){
      const homeSide = isHome(m);
      const squadra1 = homeSide ? 'Corbiolo' : (m.casa || 'Avversario');
      const squadra2 = homeSide ? (m.fuori || 'Avversario') : 'Corbiolo';
      const icon = homeSide ? 'üè†' : '‚úàÔ∏è';
      const pillClass = homeSide ? 'home-pill' : 'away-pill';
      const ds = m.date.toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short'});
      return `
        <div class="future-row">
          <div class="team-line">
            <span class="pill ${pillClass}">${icon}</span>
            <span class="team-badge"><img src="${teamLogo(m,'left')}" alt=""></span>
            <strong>${squadra1}</strong>
            <span class="muted">-</span>
            <strong>${squadra2}</strong>
            <span class="team-badge"><img src="${teamLogo(m,'right')}" alt=""></span>
          </div>
          <div class="small">${ds}</div>
        </div>`;
    }

    const list = document.getElementById('futureList');
    list.innerHTML = futures.length ? futures.map(row).join('') : '<div class="small">Nessuna partita in programma</div>';

    // SW
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>
