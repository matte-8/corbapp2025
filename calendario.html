<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Calendario - CORB</title>

  <!-- PWA / Icone -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="img/logo_c5.png">

  <!-- CSS comune -->
  <link rel="stylesheet" href="./style.css?v=33">
  <style>
    /* Extra minimi specifici della pagina */
    .month-wrap{margin-bottom:18px}
    .month-head{display:flex;align-items:center;justify-content:space-between}
    .month-name{font-weight:900;line-height:1.05;font-size:clamp(20px,6vw,28px)}
    .head-right{display:flex;gap:8px}
    .arrowbtn{border-radius:12px;border:1px solid var(--ring);background:#fff;padding:6px 10px}
    .legend{display:flex;gap:16px;align-items:center;margin-top:8px}
    .dot{width:10px;height:10px;border-radius:999px}
    .dot-home{background:var(--home)}
    .dot-away{background:var(--away)}
    /* pi√π aria tra intestazione mese e griglia */
    .cal-dow{margin:12px 0 6px}
    .month-block{margin-bottom:8px}
  </style>
</head>
<body>
  <!-- Topbar comune -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" class="brand" aria-label="Home">
        <img src="img/logo_c5.png" alt="Corbiolo" class="brand-logo">
        <span class="title">Calendario</span>
      </a>
    </div>
    <div class="right">
      <button data-role="menu-btn" class="iconbtn" aria-label="Apri menu" title="Menu">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Drawer comune -->
  <nav class="drawer" data-role="drawer" aria-label="Menu laterale">
    <button class="drawer-close" data-role="drawer-close" aria-label="Chiudi">‚úï</button>
    <h3>Menu</h3>
    <a href="./index.html">üè† Home</a>
    <a href="./news.html">üì∞ News</a>
    <a href="./squadra.html">üë• Squadra</a>
    <a href="./video.html">üé• Video</a>
    <a href="./prossima.html">üìÖ Prossima partita</a>
    <a href="./partite.html">üèÜ Risultati</a>
    <a href="./calendario.html">üìÜ Calendario</a>
    <a href="./admin.html">‚öôÔ∏è Admin</a>
  </nav>

  <main class="container">
    <section class="card month-wrap">
      <!-- Mese 1: frecce SOPRA, legenda SOTTO -->
      <div class="month-head">
        <div class="month-name" id="m1"></div>
        <div class="head-right">
          <button class="arrowbtn" id="prevM" title="Mese precedente">‚Üê</button>
          <button class="arrowbtn" id="nextM" title="Mese successivo">‚Üí</button>
        </div>
      </div>
      <div class="legend small">
        <span class="dot dot-home"></span> Casa
        <span class="dot dot-away" style="margin-left:12px"></span> Trasferta
      </div>

      <div class="month-block">
        <div class="cal-dow"><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span><span>Dom</span></div>
        <div id="grid1" class="cal-grid"></div>
      </div>

      <!-- Spazio tra i mesi -->
      <div style="height:16px"></div>

      <!-- Mese 2 (solo etichetta, niente frecce) -->
      <div class="month-head">
        <div class="month-name" id="m2"></div>
        <div style="width:68px"></div><!-- per simmetria -->
      </div>
      <div class="month-block">
        <div class="cal-dow"><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span><span>Dom</span></div>
        <div id="grid2" class="cal-grid"></div>
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px 0">Prossime partite</h2>
      <div id="futureList"></div>
    </section>

    <section class="card small">
      Ultimo aggiornamento dati: <span id="ls">never</span>
    </section>
  </main>

  <script type="module">
    import { last, get } from './data-store.js';

    // Ultimo sync
    document.getElementById('ls').textContent = last();

    // ===== Helpers calendario =====
    const toDate = (d) => {
      if (!d) return new Date('Invalid');
      if (/^\d{4}-\d{2}-\d{2}/.test(d)) return new Date(d);
      const m = d.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (m){ const dd=+m[1], mm=+m[2]-1, yy=(+m[3]<100?2000+ +m[3]:+m[3]); return new Date(yy,mm,dd); }
      const dt = new Date(d);
      return isNaN(+dt) ? new Date('Invalid') : dt;
    };
    const fmtMonth = (d) => d.toLocaleDateString(undefined,{month:'long',year:'numeric'});
    const daysInMonth = (y,m) => new Date(y, m+1, 0).getDate();
    // Luned√¨-first: 0=Mon
    const startDowMon = (y,m) => (new Date(y,m,1).getDay()+6)%7;

    // Dati calendario dal localStorage (admin)
    const calData = (get('calendar')||[]).map(r=>({
      date: toDate(r.data),
      avversario: r.avversario || '',
      casa_fuori: (r.casa_fuori||'').toLowerCase()
    })).filter(e=>!isNaN(+e.date));

    let offset = 0; // finestra di 2 mesi scorrevole

    function buildTwoMonths(){
      const base = new Date();
      const mA = new Date(base.getFullYear(), base.getMonth()+offset, 1);
      const mB = new Date(base.getFullYear(), base.getMonth()+offset+1, 1);
      buildMonth('grid1','m1', mA);
      buildMonth('grid2','m2', mB);
    }

    function buildMonth(gridId, labelId, baseDate){
      const y = baseDate.getFullYear(), m = baseDate.getMonth();
      document.getElementById(labelId).textContent = fmtMonth(baseDate);
      const grid = document.getElementById(gridId);
      grid.innerHTML = '';

      // celle vuote prima dell'1 del mese (con settimana che parte da luned√¨)
      const leading = startDowMon(y,m);
      for(let i=0;i<leading;i++){
        const c = document.createElement('div');
        c.className = 'cal-cell muted';
        grid.appendChild(c);
      }

      const nDays = daysInMonth(y,m);
      for(let d=1; d<=nDays; d++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.textContent = d;

        const match = calData.find(e =>
          e.date.getFullYear()===y && e.date.getMonth()===m && e.date.getDate()===d
        );
        if (match){
          cell.classList.add('has');
          if (match.casa_fuori === 'casa') cell.classList.add('home');
          else cell.classList.add('away');
          // tooltip ordine squadre corretto
          cell.title = (match.casa_fuori==='casa' ? 'Corbiolo - ' : '') +
                       match.avversario +
                       (match.casa_fuori==='fuori' ? ' - Corbiolo' : '');
        }

        grid.appendChild(cell);
      }
    }

    // Frecce per navigare i mesi
    document.getElementById('prevM').addEventListener('click', ()=>{
      offset -= 1; buildTwoMonths(); window.scrollTo({top:0,behavior:'smooth'});
    });
    document.getElementById('nextM').addEventListener('click', ()=>{
      offset += 1; buildTwoMonths(); window.scrollTo({top:0,behavior:'smooth'});
    });

    buildTwoMonths();

    // ===== Lista future partite sotto =====
    const matches = (get('matches')||[]).map(m=>({
      ...m,
      date: new Date((m.data||'')+'T'+(m.ora||'00:00'))
    })).filter(m=>!isNaN(+m.date));

    const now = new Date();
    const futures = matches.filter(m=> m.date > now).sort((a,b)=> a.date - b.date);

    const isHome = m => (m.casa||'').trim().toLowerCase() === 'corbiolo';
    const fmtListDate = (d) => d.toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short'});

    function row(m){
      const homeSide = isHome(m);
      const s1 = homeSide ? 'Corbiolo' : (m.casa||'Avversario');
      const s2 = homeSide ? (m.fuori||'Avversario') : 'Corbiolo';
      const icon = homeSide ? 'üè†' : '‚úàÔ∏è';
      const pillClass = homeSide ? 'badge badge-green' : 'badge badge-amber';
      const ds = fmtListDate(m.date);
      return `
        <div class="future-row">
          <div class="row">
            <span class="pill" style="margin-right:6px">${icon}</span>
            <div>
              <div><strong>${s1} - ${s2}</strong></div>
              <div class="small">${ds}</div>
            </div>
          </div>
        </div>`;
    }

    const list = document.getElementById('futureList');
    list.innerHTML = futures.length ? futures.map(row).join('') : '<div class="small">Nessuna partita in programma</div>';

    // SW
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>

  <!-- JS menu comune -->
  <script src="./ui.js?v=33"></script>
</body>
</html>
