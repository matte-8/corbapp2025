<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Calendario - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css">
  <style>
    .legend{display:flex;gap:16px;align-items:center}
    .dot{width:10px;height:10px;border-radius:999px}
    .home{background:#6b0f1a!important;color:#fff!important;border-color:#6b0f1a!important}
    .away{background:#0ea5e9!important;color:#fff!important;border-color:#0ea5e9!important}
    .cal-cell.has{font-weight:700;box-shadow:0 2px 10px rgba(0,0,0,.12)}
    .future-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--ring)}
    .future-row:last-child{border-bottom:0}
    .home-pill{background:#f3e8eb;border:1px solid #e4cbd3;color:#6b0f1a}
    .away-pill{background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.35);color:#0ea5e9}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" style="color:#fff">‚Üê</a>
      <div class="title" style="font-weight:700;margin-left:8px">Calendario</div>
    </div>
    <div class="right"></div>
  </header>

  <main class="container">
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0" id="m1"></h2>
        <div class="legend small">
          <span class="dot" style="background:#6b0f1a"></span> Casa
          <span class="dot" style="background:#0ea5e9"></span> Trasferta
        </div>
      </div>
      <div class="cal-dow"><span>Dom</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span></div>
      <div id="grid1" class="cal-grid"></div>

      <h2 style="margin:18px 0 0" id="m2"></h2>
      <div class="cal-dow"><span>Dom</span><span>Lun</span><span>Mar</span><span>Mer</span><span>Gio</span><span>Ven</span><span>Sab</span></div>
      <div id="grid2" class="cal-grid"></div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 8px 0">Prossime partite</h2>
      <div id="futureList"></div>
    </section>
  </main>

  <script type="module">
    import {get} from './data-store.js';

    // === Helpers ===
    function toDate(d) {
      if (!d) return new Date('Invalid');
      if (/^\d{4}-\d{2}-\d{2}/.test(d)) return new Date(d);
      const m = d.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (m) {
        const dd=+m[1], mm=+m[2]-1, yy=(+m[3]<100?2000+ +m[3]:+m[3]);
        return new Date(yy,mm,dd);
      }
      return new Date(d);
    }
    const fmtMonth = (d) => d.toLocaleDateString(undefined,{month:'long',year:'numeric'});
    const daysInMonth = (y,m) => new Date(y, m+1, 0).getDate();
    const startDow = (y,m) => new Date(y,m,1).getDay(); // 0=dom

    const calData = (get('calendar')||[]).map(r=>({
      date: toDate(r.data),
      avversario: r.avversario || '',
      casa_fuori: (r.casa_fuori||'').toLowerCase()
    })).filter(e=>!isNaN(+e.date));

    // Costruiamo due mesi: corrente e successivo
    const today = new Date();
    const months = [
      new Date(today.getFullYear(), today.getMonth(), 1),
      new Date(today.getFullYear(), today.getMonth()+1, 1)
    ];

    function buildMonth(rootId, labelId, baseDate){
      const y = baseDate.getFullYear(), m = baseDate.getMonth();
      document.getElementById(labelId).textContent = fmtMonth(baseDate);
      const grid = document.getElementById(rootId);
      grid.innerHTML = '';

      const leading = startDow(y,m); // quanti vuoti prima del 1¬∞
      for(let i=0;i<leading;i++){
        const c = document.createElement('div');
        c.className = 'cal-cell muted';
        grid.appendChild(c);
      }

      const nDays = daysInMonth(y,m);
      for(let d=1; d<=nDays; d++){
        const cell = document.createElement('div');
        cell.className = 'cal-cell';
        cell.textContent = d;

        // evento in quel giorno?
        const match = calData.find(e =>
          e.date.getFullYear()===y && e.date.getMonth()===m && e.date.getDate()===d
        );
        if (match){
          cell.classList.add('has');
          if (match.casa_fuori === 'casa') cell.classList.add('home');
          else cell.classList.add('away');
          cell.title = (match.casa_fuori==='casa' ? 'Corbiolo - ' : '') +
                       match.avversario +
                       (match.casa_fuori==='fuori' ? ' - Corbiolo' : '');
        }

        grid.appendChild(cell);
      }
    }

    buildMonth('grid1','m1', months[0]);
    buildMonth('grid2','m2', months[1]);

    // ---- Lista future sotto (dalla tab partite, ordinata) ----
    const matches = (get('matches')||[]).map(m=>({
      ...m,
      date: new Date((m.data||'')+'T'+(m.ora||'00:00'))
    })).filter(m=>!isNaN(+m.date));

    const now = new Date();
    const futures = matches.filter(m=> m.date > now).sort((a,b)=> a.date - b.date);

    const isHome = m => (m.casa||'').trim().toLowerCase() === 'corbiolo';
    function row(m){
      const homeSide = isHome(m);
      const squadra1 = homeSide ? 'Corbiolo' : (m.casa || 'Avversario');
      const squadra2 = homeSide ? (m.fuori || 'Avversario') : 'Corbiolo';
      const icon = homeSide ? 'üè†' : '‚úàÔ∏è';
      const pillClass = homeSide ? 'home-pill' : 'away-pill';
      const ds = m.date.toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short'});
      return `
        <div class="future-row">
          <div class="row">
            <span class="pill ${pillClass}">${icon}</span>
            <div>
              <div><strong>${squadra1} - ${squadra2}</strong></div>
              <div class="small">${ds}</div>
            </div>
          </div>
        </div>`;
    }

    const list = document.getElementById('futureList');
    list.innerHTML = futures.length ? futures.map(row).join('') : '<div class="small">Nessuna partita in programma</div>';

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>
