<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Risultati - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css?v=24">
</head>
<body>
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" style="color:#fff">←</a>
      <div class="title" style="font-weight:700;margin-left:8px">Risultati</div>
    </div>
    <div class="right">
      <button id="menuBtn" class="iconbtn" aria-label="Menu" title="Menu">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <nav id="drawer">
    <span id="drawer-close">✕</span>
    <h3>Menu</h3>
    <a href="./news.html">📰 News</a>
    <a href="./squadra.html">👥 Squadra</a>
    <a href="./video.html">🎥 Video</a>
    <a href="./prossima.html">📅 Prossima partita</a>
    <a href="./partite.html">🏆 Risultati</a>
    <a href="./calendario.html">📆 Calendario</a>
    <a href="./admin.html">⚙️ Admin</a>
  </nav>
  <script>
    (function(){
      const d=document,dr=d.getElementById('drawer'),b=d.getElementById('menuBtn'),x=d.getElementById('drawer-close');
      b&&b.addEventListener('click',e=>{e.stopPropagation();dr.classList.add('open')});
      x&&x.addEventListener('click',()=>dr.classList.remove('open'));
      d.addEventListener('click',e=>{
        if(dr.classList.contains('open')&&!dr.contains(e.target)&&e.target!==b) dr.classList.remove('open');
      });
    })();
  </script>

  <main class="container">
    <!-- Statistiche stagione (compatto come da mock) -->
    <section class="card" id="statsCard" style="background:linear-gradient(180deg,var(--granata),var(--granata-2));color:#fff">
      <div class="row" style="justify-content:space-between;align-items:flex-start">
        <h2 style="margin:0">Statistiche Stagione</h2>
        <div id="stagioneLabel" class="small" style="opacity:.9"></div>
      </div>

      <div class="row" style="margin-top:10px;gap:8px;flex-wrap:nowrap;overflow:auto">
        <div class="card" style="min-width:100px;background:rgba(255,255,255,.08);border-color:transparent;color:#fff;text-align:center">
          <div style="font-size:22px;font-weight:800" id="statPartite">0</div>
          <div class="small">Partite</div>
        </div>
        <div class="card" style="min-width:100px;background:rgba(255,255,255,.08);border-color:transparent;color:#fff;text-align:center">
          <div style="font-size:22px;font-weight:800" id="statVittorie">0</div>
          <div class="small">Vittorie</div>
        </div>
        <div class="card" style="min-width:100px;background:rgba(255,255,255,.08);border-color:transparent;color:#fff;text-align:center">
          <div style="font-size:22px;font-weight:800" id="statPareggi">0</div>
          <div class="small">Pareggi</div>
        </div>
        <div class="card" style="min-width:100px;background:rgba(255,255,255,.08);border-color:transparent;color:#fff;text-align:center">
          <div style="font-size:22px;font-weight:800" id="statSconfitte">0</div>
          <div class="small">Sconfitte</div>
        </div>
      </div>

      <div class="row" style="margin-top:10px;gap:8px;flex-wrap:nowrap;overflow:auto">
        <div class="card" style="min-width:120px;background:#fff;border-color:transparent;text-align:center;color:var(--text)">
          <div class="small">Gol Fatti</div>
          <div style="font-size:22px;font-weight:800" id="statGF">0</div>
        </div>
        <div class="card" style="min-width:120px;background:#fff;border-color:transparent;text-align:center;color:var(--text)">
          <div class="small">Gol Subiti</div>
          <div style="font-size:22px;font-weight:800" id="statGS">0</div>
        </div>
        <div class="card" style="min-width:120px;background:#fff;border-color:transparent;text-align:center;color:var(--text)">
          <div class="small">Differenza</div>
          <div style="font-size:22px;font-weight:800" id="statDiff">0</div>
        </div>
      </div>
    </section>

    <!-- Lista risultati (solo già giocati, più recenti in alto) -->
    <section class="card">
      <h2 style="margin:0 0 8px 0">Risultati Recenti</h2>
      <div id="results"></div>
    </section>
  </main>

  <script type="module">
    import {get} from './data-store.js';

    const rows = (get('partite')||[]).map(m => ({
      ...m,
      date: new Date((m.data||'')+'T'+(m.ora||'00:00'))
    })).filter(m => !isNaN(+m.date));

    // solo giocate (con risultato presente)
    const played = rows.filter(r => (r.risultato||'').trim() !== '')
                       .sort((a,b)=> b.date - a.date);

    // stat
    let p=0,v=0,n=0,s=0,gf=0,gs=0;
    played.forEach(r=>{
      p++;
      const m = (r.risultato||'').match(/(\d+)\s*[-:]\s*(\d+)/);
      if (m){
        const a = parseInt(m[1],10), b = parseInt(m[2],10);
        const home = (r.casa||'').trim().toLowerCase() === 'corbiolo';
        const mine = home ? a : b;
        const opp  = home ? b : a;
        gf += mine; gs += opp;
        if (mine>opp) v++; else if (mine===opp) n++; else s++;
      }
    });
    const diff = gf-gs;

    // stagione label (settembre anno → giugno anno+1)
    const now = new Date();
    const y = now.getMonth()>=8 ? now.getFullYear() : now.getFullYear()-1;
    document.getElementById('stagioneLabel').textContent = `Stagione ${String(y).slice(2)}/${String(y+1).slice(2)}`;

    // stampa stat
    document.getElementById('statPartite').textContent = p;
    document.getElementById('statVittorie').textContent = v;
    document.getElementById('statPareggi').textContent  = n;
    document.getElementById('statSconfitte').textContent= s;
    document.getElementById('statGF').textContent = gf;
    document.getElementById('statGS').textContent = gs;
    document.getElementById('statDiff').textContent = (diff>0?'+':'')+diff;

    const results = document.getElementById('results');

    const rowHtml = (r) => {
      const home = (r.casa||'').trim().toLowerCase() === 'corbiolo';
      const s1   = home ? 'Corbiolo' : (r.casa||'');
      const s2   = home ? (r.fuori||'') : 'Corbiolo';
      const ds   = r.date.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
      const logoHome = home ? 'img/logo_c5.png' : (r.logocasa||'img/logo_avv.png');
      const logoAway = home ? (r.logoavv||'img/logo_avv.png') : 'img/logo_c5.png';

      return `
        <div class="player" style="align-items:center">
          <img src="${logoHome}" alt="" style="width:42px;height:42px;border-radius:10px;object-fit:cover"
               onerror="this.onerror=null;this.src='img/logo_avv.png'">
          <div style="flex:1;margin:0 10px">
            <div class="small" style="opacity:.7">${ds}</div>
            <div style="font-weight:700">${s1} - ${s2}</div>
          </div>
          <div class="score">${r.risultato||'-'}</div>
          <img src="${logoAway}" alt="" style="width:42px;height:42px;border-radius:10px;object-fit:cover;margin-left:10px"
               onerror="this.onerror=null;this.src='img/logo_avv.png'">
        </div>`;
    };

    results.innerHTML = played.length ? played.map(rowHtml).join('') : '<div class="small">Nessun risultato</div>';

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>
