<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Risultati - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css?v=14">
</head>
<body>
  
  <!-- Topbar -->
<header class="topbar">
  <div class="nav">
    <a href="./index.html" class="brand">
      <img src="img/logo_c5.png" alt="Corbiolo" class="brand-logo">
      <span class="title">Partite</span>
    </a>
  </div>
  <div class="right">
    <button data-role="menu-btn" class="iconbtn" aria-label="Menu" title="Menu">
      <!-- hamburger (solo 3 linee) -->
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none"
           stroke="#ffffff" stroke-width="2" stroke-linecap="round">
        <path d="M3 6h18M3 12h18M3 18h18"/>
      </svg>
    </button>
  </div>
</header>

<!-- Drawer menu (uguale per tutte le pagine) -->
<nav class="drawer" data-role="drawer">
  <button class="drawer-close" data-role="drawer-close" aria-label="Chiudi">âœ•</button>
  <h3>Menu</h3>
  <a href="./index.html">ğŸ  Home</a>
  <a href="./news.html">ğŸ“° News</a>
  <a href="./squadra.html">ğŸ‘¥ Squadra</a>
  <a href="./video.html">ğŸ¥ Video</a>
  <a href="./prossima.html">ğŸ“… Prossima partita</a>
  <a href="./partite.html">ğŸ† Risultati</a>
  <a href="./calendario.html">ğŸ“† Calendario</a>
  <a href="./admin.html">âš™ï¸ Admin</a>
</nav>


  <main class="container">
    <!-- Ricerca + chip -->
    <section class="card">
      <div class="search">
        <span>ğŸ”</span>
        <input id="q" placeholder="Cerca partite, squadre o competizioni...">
      </div>
      <div class="chips" id="chips" style="margin-top:12px">
        <span class="chip active" data-k="all">Tutte le competizioni</span>
        <span class="chip" data-k="serie">Campionato</span>
        <span class="chip" data-k="coppa">Coppa Veneto</span>
      </div>
    </section>

    <!-- Statistiche stagione -->
    <section class="stat-card">
      <div class="stat-head">
        <div class="stat-title singleline">ğŸ“Š Statistiche Stagione</div>
        <div class="stat-season" id="seasonLabel">Stagione --/--</div>
      </div>

      <div class="kpi-mini">
        <div class="mini">
          <div class="ico">ğŸ®</div>
          <div class="val" id="k-played">0</div>
          <div class="lbl">Partite</div>
        </div>
        <div class="mini">
          <div class="ico">ğŸ†</div>
          <div class="val" id="k-wins">0</div>
          <div class="lbl">Vittorie</div>
        </div>
        <div class="mini">
          <div class="ico">â€”</div>
          <div class="val" id="k-draws">0</div>
          <div class="lbl">Pareggi</div>
        </div>
        <div class="mini">
          <div class="ico">âœ–</div>
          <div class="val" id="k-losses">0</div>
          <div class="lbl">Sconfitte</div>
        </div>
      </div>

      <div class="kpi-big">
        <div class="big">
          <div class="ico">ğŸ¥…</div>
          <div class="val" id="k-gf">0</div>
          <div class="lbl">Gol Fatti</div>
        </div>
        <div class="big">
          <div class="ico">ğŸ›¡ï¸</div>
          <div class="val" id="k-ga">0</div>
          <div class="lbl">Gol Subiti</div>
        </div>
        <div class="big">
          <div class="ico">Â±</div>
          <div class="val" id="k-gd">0</div>
          <div class="lbl">Differenza</div>
        </div>
      </div>

      <div class="form-wrap">
        <div class="muted">Forma Attuale:</div>
        <div id="formDots"></div>
      </div>
    </section>

    <!-- Risultati recenti -->
    <section class="card" id="resultsCard">
      <h3 style="margin:0 0 10px 0" class="muted">Risultati Recenti</h3>
      <div id="resultsList"></div>
    </section>
  </main>

 <script type="module">
  import {get} from './data-store.js';

  // Drawer
  const drawer = document.getElementById('drawer');
  const btn = document.getElementById('menuBtn');
  const closeBtn = document.getElementById('drawer-close');

  btn.addEventListener('click', (e) => {
    e.stopPropagation();
    drawer.classList.add('open');
  });
  closeBtn.addEventListener('click', () => drawer.classList.remove('open'));
  // Chiudi toccando fuori
  document.addEventListener('click', (e) => {
    if (drawer.classList.contains('open') && !drawer.contains(e.target) && e.target !== btn) {
      drawer.classList.remove('open');
    }
  });

  /* â€¦ il resto del tuo codice calendario qui sotto (helpers, buildTwoMonths, ecc.) â€¦ */

    // Helper date
    const toDateTime = (d, t='00:00') => new Date((d||'')+'T'+(t||'00:00'));
    const now = new Date();

    // Dati partite dal data-store (Google Sheets -> matches)
    // Attesi campi: data, ora, casa, fuori, risultato (tipo "2-1") opzionale
    const raw = (get('matches')||[]).map(m=>({
      ...m,
      date: toDateTime(m.data, m.ora)
    })).filter(m => !isNaN(+m.date));

    // Filtra passate (risultati)
    const past = raw.filter(m => m.date <= now).sort((a,b)=> b.date - a.date);

    // Utils
    const isHome = m => (m.casa||'').trim().toLowerCase() === 'corbiolo';
    const parseScore = (s='')=>{
      const m = String(s).match(/(-?\d+)\s*[-:]\s*(-?\d+)/);
      if (!m) return null;
      return {h:+m[1], a:+m[2]};
    };
    const outcome = (m)=>{
      // calcola esito per Corbiolo
      const sc = parseScore(m.risultato||'');
      if (!sc) return null;
      const homeSide = isHome(m);
      const gf = homeSide ? sc.h : sc.a;
      const ga = homeSide ? sc.a : sc.h;
      if (gf>ga) return 'V';
      if (gf===ga) return 'P';
      return 'S';
    };

    // KPI
    function buildStats(list){
      let played=0,w=0,d=0,l=0,gf=0,ga=0;
      list.forEach(m=>{
        const sc = parseScore(m.risultato||'');
        if (!sc) return; // se non abbiamo punteggio non contiamo
        played++;
        const homeSide = isHome(m);
        const myGF = homeSide ? sc.h : sc.a;
        const myGA = homeSide ? sc.a : sc.h;
        gf += myGF; ga += myGA;
        if (myGF>myGA) w++; else if (myGF===myGA) d++; else l++;
      });
      // Fill UI
      document.getElementById('k-played').textContent = played;
      document.getElementById('k-wins').textContent   = w;
      document.getElementById('k-draws').textContent  = d;
      document.getElementById('k-losses').textContent = l;
      document.getElementById('k-gf').textContent     = gf;
      document.getElementById('k-ga').textContent     = ga;
      document.getElementById('k-gd').textContent     = (gf-ga>=0?'+':'') + (gf-ga);
      // Form (ultime 5)
      const dots = document.getElementById('formDots');
      const last5 = list.filter(m=>parseScore(m.risultato||'')).slice(0,5).map(outcome);
      dots.innerHTML = last5.map(ch=>{
        if (ch==='V') return '<span class="form-dot fW">V</span>';
        if (ch==='P') return '<span class="form-dot fD">P</span>';
        if (ch==='S') return '<span class="form-dot fL">S</span>';
        return '';
      }).join('');
    }

    // Stagione (setâ†’giu)
    function getSeasonLabel(date = new Date()) {
      const y = date.getFullYear();
      const m = date.getMonth(); // 0..11
      let startYear = (m >= 8) ? y : (y - 1);
      const endYear = startYear + 1;
      const yy = String(startYear).slice(-2);
      const yy2 = String(endYear).slice(-2);
      return `${yy}/${yy2}`;
    }
    document.getElementById('seasonLabel').textContent = `Stagione ${getSeasonLabel(now)}`;

    // Render risultati
    const listEl = document.getElementById('resultsList');
    const fmtDay = (d)=> d.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});

    function badgeEsito(o){
      if (o==='V') return '<span class="badge badge-green">VITTORIA</span>';
      if (o==='P') return '<span class="badge badge-amber">PAREGGIO</span>';
      if (o==='S') return '<span class="badge badge-red">SCONFITTA</span>';
      return '';
    }

    function row(m){
      const homeSide = isHome(m);
      const leftTeam  = homeSide ? 'Corbiolo' : (m.casa || 'Avversario');
      const rightTeam = homeSide ? (m.fuori || 'Avversario') : 'Corbiolo';
      const out = outcome(m);
      const dataStr = fmtDay(m.date);
      const score = (m.risultato||'0-0').replace(':','-');
      return `
        <article class="card" style="padding:14px;margin-bottom:10px">
          <div class="muted" style="margin-bottom:6px">${m.competizione||'Campionato'}</div>
          <div class="row" style="justify-content:space-between;align-items:center">
            <div>
              <div style="font-weight:800;font-size:20px">${leftTeam}</div>
              <div class="small">${homeSide ? 'Casa' : 'Trasferta'}</div>
            </div>
            <div class="score">${score.replace(/\s/g,'').split('-')[0]} - ${score.replace(/\s/g,'').split('-')[1]}</div>
            <div style="text-align:right">
              <div style="font-weight:800;font-size:20px">${rightTeam}</div>
              <div class="small">${homeSide ? 'Trasferta (avv.)' : 'Casa (avv.)'}</div>
            </div>
          </div>
          <div class="row" style="margin-top:8px;justify-content:space-between;align-items:center">
            ${badgeEsito(out)}
            <div class="small">${dataStr}</div>
          </div>
        </article>`;
    }

    function apply(){
      const q = (document.getElementById('q').value||'').toLowerCase().trim();
      const active = document.querySelector('#chips .chip.active')?.dataset.k || 'all';
      const filtered = past.filter(m=>{
        // filtro competizione se mai vorrai usarlo: qui Ã¨ placeholder
        const okComp = true; // active==='all' || (m.competizione||'').toLowerCase().includes(active)
        const hay = `${m.casa||''} ${m.fuori||''} ${m.competizione||''}`.toLowerCase();
        const okQ = hay.includes(q);
        return okComp && okQ;
      });
      buildStats(filtered);
      listEl.innerHTML = filtered.length ? filtered.map(row).join('') : '<div class="small">Nessun risultato</div>';
    }

    document.getElementById('q').addEventListener('input', apply);
    document.querySelectorAll('#chips .chip').forEach(ch=>{
      ch.addEventListener('click', ()=>{
        ch.parentElement.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        ch.classList.add('active');
        apply();
      });
    });

    // First render
    apply();

    // SW
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>
