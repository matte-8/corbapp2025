<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Risultati - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css">

  <style>
    /* ====== STAT CARD stile "mock" ====== */
    .stat-card{
      background:linear-gradient(180deg,#7d2631,#6b0f1a);
      color:#fff;border-radius:18px;padding:14px 14px 12px;
      box-shadow:0 10px 26px rgba(0,0,0,.14)
    }
    .stat-head{display:flex;justify-content:space-between;align-items:center}
    .stat-title{display:flex;gap:8px;align-items:center;font-weight:800;font-size:20px}
    .stat-range{opacity:.9;font-size:12px;line-height:1.1;text-align:right}

    /* Riga KPI compatti (4) */
    .kpi-mini{
      display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px
    }
    .mini{
      background:#ffffff12;border:1px solid #ffffff26;border-radius:16px;
      padding:10px 6px;text-align:center;min-height:84px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px
    }
    .mini .ico{font-size:18px;line-height:1}
    .mini .val{font-weight:900;font-size:22px;line-height:1}
    .mini .lbl{font-size:12px;opacity:.95}

    /* Riga "Gol" (3 card pi√π grandi) */
    .kpi-big{
      display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px
    }
    .big{
      background:#ffffff18;border:1px solid #ffffff2b;border-radius:16px;
      padding:12px 10px;text-align:center;min-height:88px;
      display:flex;flex-direction:column;justify-content:center;gap:6px
    }
    .big .ico{font-size:18px}
    .big .val{font-weight:900;font-size:26px}
    .big .lbl{font-size:13px;opacity:.95}

    /* Forma attuale */
    .form-wrap{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
    .form-dot{
      width:26px;height:26px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;
      font-weight:800;color:#fff;font-size:12px
    }
    .fW{background:#10b981}.fD{background:#f59e0b}.fL{background:#ef4444}

    /* Responsiveness: mantiene l‚Äôaspetto su qualsiasi mobile */
    @media(max-width:410px){
      .mini .val{font-size:20px}
      .big .val{font-size:24px}
      .kpi-mini{gap:8px}
      .kpi-big{gap:10px}
    }
    @media(max-width:340px){
      .kpi-mini{grid-template-columns:repeat(2,1fr)}
      .kpi-big{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <!-- Barra superiore -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" style="color:#fff">‚Üê</a>
      <div class="title" style="font-weight:700;margin-left:8px">Risultati</div>
    </div>
    <div class="right">
      <a class="iconbtn" href="./admin.html" title="Admin">‚ü≥</a>
    </div>
  </header>

  <main class="container">
    <!-- Filtri -->
    <section class="card">
      <div class="search">
        <span>üîé</span>
        <input id="q" placeholder="Cerca partite, squadre o competizioni...">
      </div>
      <div class="chips" id="comp" style="margin-top:10px">
        <span class="chip active" data-comp="">Tutte le competizioni</span>
        <span class="chip" data-comp="Serie A Futsal">Serie A Futsal</span>
        <span class="chip" data-comp="Coppa Italia Futsal">Coppa Italia Futsal</span>
      </div>
    </section>

    <!-- üìä Statistiche Stagione (layout identico al mock) -->
    <section class="stat-card">
      <div class="stat-head">
        <div class="stat-title"><span>üìä</span><span>Statistiche Stagione</span></div>
        <div id="statsRange" class="stat-range">‚Äî</div>
      </div>

      <!-- 4 KPI compatti -->
      <div class="kpi-mini">
        <div class="mini"><div class="ico">‚ú∫</div><div id="kGames" class="val">0</div><div class="lbl">Partite</div></div>
        <div class="mini"><div class="ico">üèÜ</div><div id="kW" class="val">0</div><div class="lbl">Vittorie</div></div>
        <div class="mini"><div class="ico">‚Äî</div><div id="kD" class="val">0</div><div class="lbl">Pareggi</div></div>
        <div class="mini"><div class="ico">‚úï</div><div id="kL" class="val">0</div><div class="lbl">Sconfitte</div></div>
      </div>

      <!-- 3 KPI pi√π grandi -->
      <div class="kpi-big">
        <div class="big"><div class="ico">ü•Ö</div><div id="kGF" class="val">0</div><div class="lbl">Gol Fatti</div></div>
        <div class="big"><div class="ico">üõ°Ô∏è</div><div id="kGA" class="val">0</div><div class="lbl">Gol Subiti</div></div>
        <div class="big"><div class="ico">¬±</div><div id="kGD" class="val">0</div><div class="lbl">Differenza</div></div>
      </div>

      <!-- Forma attuale -->
      <div class="form-wrap">
        <div class="small" style="opacity:.95">Forma Attuale:</div>
        <div id="formRow"></div>
      </div>
    </section>

    <!-- Lista partite -->
    <section id="list"></section>
  </main>

  <!-- Script -->
  <script type="module">
    import {get} from './data-store.js';

    /* Helpers */
    function toDate(d, t='00:00') {
      if (!d) return new Date('Invalid');
      if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return new Date(`${d}T${t}`);
      const m = d.match(/^(\d{1,2})[\\/\\-\\.](\d{1,2})[\\/\\-\\.](\d{2,4})$/);
      if (m) {
        const dd=+m[1], mm=+m[2]-1, yy=(+m[3]<100?2000+ +m[3]:+m[3]);
        const [hh='00', mi='00'] = (t||'00:00').split(':');
        return new Date(yy,mm,dd,+hh||0,+mi||0);
      }
      return new Date(`${d}T${t}`);
    }
    const isHome = m => (m.casa || '').trim().toLowerCase() === 'corbiolo';

    function parseScore(r) {
      const m = (r||'').match(/(\d+)\D+(\d+)/);
      if (!m) return null;
      return {gf:+m[1], ga:+m[2]};
    }
    function resultBadge(ris) {
      const m = parseScore(ris);
      if (!m) return '';
      if (m.gf > m.ga) return '<span class="badge badge-green">VITTORIA</span>';
      if (m.gf < m.ga) return '<span class="badge badge-red">SCONFITTA</span>';
      return '<span class="badge badge-amber">PAREGGIO</span>';
    }

    /* Dataset: solo giocate */
    const now = new Date();
    const raw = get('matches') || [];
    const played = raw.map(m => ({
        ...m,
        date: toDate(m.data, m.ora),
        competizione: m.competizione || 'Serie A Futsal'
      }))
      .filter(m => !isNaN(+m.date) && m.date <= now)
      .sort((a,b) => b.date - a.date);

    /* Statistiche */
    const stats = {games:0,w:0,d:0,l:0,gf:0,ga:0,gd:0,form:[]};
    played.forEach(m => {
      const s = parseScore(m.risultato);
      if (!s) return;
      stats.games++; stats.gf+=s.gf; stats.ga+=s.ga;
      if (s.gf>s.ga){stats.w++;stats.form.push('W');}
      else if (s.gf<s.ga){stats.l++;stats.form.push('L');}
      else {stats.d++;stats.form.push('D');}
    });
    stats.gd = stats.gf - stats.ga;

    /* Range date */
    const rangeEl = document.getElementById('statsRange');
    if (played.length){
      const from = played[played.length-1].date, to = played[0].date;
      rangeEl.textContent = from.toLocaleDateString() + ' ‚Üí ' + to.toLocaleDateString();
    }

    /* Render KPI */
    const setTxt = (id,v)=>document.getElementById(id).textContent=v;
    setTxt('kGames', stats.games);
    setTxt('kW', stats.w);
    setTxt('kD', stats.d);
    setTxt('kL', stats.l);
    setTxt('kGF', stats.gf);
    setTxt('kGA', stats.ga);
    setTxt('kGD', (stats.gd>0?'+':'')+stats.gd);

    /* Forma (ultime 5) */
    document.getElementById('formRow').innerHTML =
      stats.form.slice(0,5).map(x=>{
        if(x==='W')return'<span class="form-dot fW">V</span>';
        if(x==='D')return'<span class="form-dot fD">P</span>';
        return'<span class="form-dot fL">S</span>';
      }).join('');

    /* Lista risultati */
    const list = document.getElementById('list');
    function card(m){
      const when = m.date.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
      const homeSide = isHome(m);
      const left  = homeSide ? 'Corbiolo' : (m.casa || 'Avversario');
      const right = homeSide ? (m.fuori || 'Avversario') : 'Corbiolo';
      const score = (m.risultato || '‚Äì').replace('-', ' - ');
      return `
        <article class="card" style="display:grid;gap:10px">
          <div>
            <div class="small">${m.competizione}</div>
            <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px">
              <div><strong>${left}</strong><div class="small">${homeSide ? 'Casa':'Casa (avv.)'}</div></div>
              <div class="score">${score}</div>
              <div style="text-align:right"><strong>${right}</strong><div class="small">${homeSide ? 'Trasferta (avv.)':'Trasferta'}</div></div>
            </div>
            <div class="row" style="justify-content:space-between;margin-top:6px">
              ${resultBadge(m.risultato)}
              <div class="small">${when}</div>
            </div>
          </div>
        </article>`;
    }

    function apply() {
      const q = (document.getElementById('q').value || '').toLowerCase();
      const comp = document.querySelector('#comp .chip.active')?.dataset.comp || '';
      const rows = played.filter(m =>
        (comp === '' || m.competizione === comp) &&
        (`${m.casa} ${m.fuori} ${m.risultato} ${m.competizione}`.toLowerCase().includes(q))
      );
      list.innerHTML = rows.length ? rows.map(card).join('') : '<div class="card">Nessun risultato</div>';
    }

    document.getElementById('q').addEventListener('input', apply);
    document.querySelectorAll('#comp .chip').forEach(chip=>{
      chip.addEventListener('click', ()=>{
        chip.parentElement.querySelectorAll('.chip').forEach(x=>x.classList.remove('active'));
        chip.classList.add('active');
        apply();
      });
    });

    apply();
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>
