<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Risultati - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/logo_c5.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css?v=33">
  <style>
    /* --- layout card statistiche coerente con il design scelto --- */
    .kpi-grid-4{display:grid;grid-template-columns:repeat(4,1fr);gap:10px;margin-top:12px}
    .kpi{
      background:#ffffff12;border:1px solid #ffffff26;border-radius:16px;
      padding:10px 6px;text-align:center;min-height:84px;
      display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px
    }
    .kpi .ico{font-size:18px;line-height:1}
    .kpi .val{font-weight:900;font-size:22px;line-height:1}
    .kpi .lbl{font-size:12px;opacity:.95}

    .kpi-grid-3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-top:12px}
    .kpi-big{
      background:#ffffff18;border:1px solid #ffffff2b;border-radius:16px;
      padding:12px 10px;text-align:center;min-height:88px;
      display:flex;flex-direction:column;justify-content:center;gap:6px
    }
    .kpi-big .ico{font-size:18px}
    .kpi-big .val{font-weight:900;font-size:26px}
    .kpi-big .lbl{font-size:13px;opacity:.95}

    .form-wrap{display:flex;align-items:center;gap:10px;margin-top:12px;flex-wrap:wrap}
    .form-dot{width:26px;height:26px;border-radius:999px;display:inline-flex;align-items:center;justify-content:center;font-weight:800;color:#fff;font-size:12px}
    .fW{background:#10b981}.fD{background:#f59e0b}.fL{background:#ef4444}

    /* --- righe partite giocate --- */
    .match-row{
      display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;
      padding:12px 0;border-bottom:1px solid var(--ring)
    }
    .match-row:last-child{border-bottom:0}
    .team{
      display:flex;flex-direction:column;align-items:center;justify-content:center;text-align:center
    }
    .team .logo{width:44px;height:44px;border-radius:10px;object-fit:contain;display:block}
    .team .name{font-weight:700;margin-top:6px}
    .score-badge{
      display:flex;align-items:center;justify-content:center;
      width:64px;height:64px;border-radius:14px;
      background:#f5eef0;color:#7d2631;font-weight:900;font-size:22px
    }

    /* evita overflow di qualsiasi immagine/iframe */
    .media-fluid{display:block;width:100%;max-width:100%;height:auto;border-radius:12px}

    /* migliora spazi su schermi piccoli */
    @media(max-width:380px){
      .kpi .val{font-size:20px}
      .kpi-big .val{font-size:24px}
      .score-badge{width:58px;height:58px;font-size:20px}
    }
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" class="brand">
        <img src="img/logo_c5.png" alt="Corbiolo" class="brand-logo">
        <span class="title">Risultati</span>
      </a>
    </div>
    <div class="right">
      <button id="menuBtn" class="iconbtn" aria-label="Menu" title="Menu">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Drawer -->
  <nav id="drawer" class="drawer">
    <button id="drawer-close" class="drawer-close" aria-label="Chiudi">‚úï</button>
    <h3>Menu</h3>
    <a href="./index.html">üè† Home</a>
    <a href="./news.html">üì∞ News</a>
    <a href="./squadra.html">üë• Squadra</a>
    <a href="./video.html">üé• Video</a>
    <a href="./prossima.html">üìÖ Prossima partita</a>
    <a href="./partite.html">üèÜ Risultati</a>
    <a href="./calendario.html">üìÜ Calendario</a>
    <a href="./admin.html">‚öôÔ∏è Admin</a>
  </nav>

  <main class="container">
    <!-- Statistiche stagione -->
    <section class="stat-card">
      <div class="stat-head">
        <div class="stat-title">
          <span style="font-size:18px">üìä</span>
          <span>Statistiche Stagione</span>
        </div>
        <div class="stat-range small" id="seasonLabel">Stagione</div>
      </div>

      <div class="kpi-grid-4">
        <div class="kpi"><div class="ico">üéØ</div><div class="val" id="kPartite">0</div><div class="lbl">Partite</div></div>
        <div class="kpi"><div class="ico">‚úÖ</div><div class="val" id="kVittorie">0</div><div class="lbl">Vittorie</div></div>
        <div class="kpi"><div class="ico">‚ûñ</div><div class="val" id="kPareggi">0</div><div class="lbl">Pareggi</div></div>
        <div class="kpi"><div class="ico">‚ùå</div><div class="val" id="kSconfitte">0</div><div class="lbl">Sconfitte</div></div>
      </div>

      <div class="kpi-grid-3">
        <div class="kpi-big"><div class="ico">‚öΩÔ∏è</div><div class="val" id="kFatti">0</div><div class="lbl">Gol fatti</div></div>
        <div class="kpi-big"><div class="ico">üõ°Ô∏è</div><div class="val" id="kSubiti">0</div><div class="lbl">Gol subiti</div></div>
        <div class="kpi-big"><div class="ico">¬±</div><div class="val" id="kDiff">0</div><div class="lbl">Differenza reti</div></div>
      </div>

      <div class="form-wrap">
        <span class="small">Forma attuale:</span>
        <div id="formDots"></div>
      </div>
    </section>

    <!-- Elenco risultati giocati -->
    <section class="card">
      <h2 style="margin:0 0 8px 0">Tutte le partite giocate</h2>
      <div id="played"></div>
    </section>
  </main>

  <script type="module">
    import {get} from './data-store.js';

    // Drawer
    const drawer = document.getElementById('drawer');
    document.getElementById('menuBtn').onclick = () => drawer.classList.add('open');
    document.getElementById('drawer-close').onclick = () => drawer.classList.remove('open');
    document.addEventListener('click', (e)=>{
      if (drawer.classList.contains('open') && !drawer.contains(e.target) && e.target.id!=='menuBtn'){
        drawer.classList.remove('open');
      }
    });

    // Helpers
    const CORB = 'corbiolo';
    const logoCorb = 'img/logo_c5.png';
    const logoAvv  = 'img/logo_avv.png';

    const toDate = (m) => {
      const d = (m.data||'') + 'T' + (m.ora||'00:00');
      const dt = new Date(d);
      return isNaN(+dt) ? new Date(m.data||'') : dt;
    };
    const parseScore = (s='')=>{
      const m = String(s).trim().match(/(\d+)\s*[-‚Äì]\s*(\d+)/);
      return m ? {gh:+m[1], ga:+m[2]} : null;
    };
    const fmtDay = (d)=> d.toLocaleDateString(undefined,{day:'2-digit',month:'short',year:'numeric'});

    const raw = (get('matches')||[]).map(x=>({...x, date: toDate(x)}));
    // giocate = hanno risultato valido
    const played = raw.filter(x=> parseScore(x.risultato));

    // ---- STATISTICHE
    let P=0,V=0,N=0,S=0,GF=0,GA=0;
    // forma (ultime 5)
    const recent = [...played].sort((a,b)=> b.date - a.date).slice(0,5);

    played.forEach(m=>{
      const home = (m.casa||'').trim().toLowerCase();
      const away = (m.fuori||'').trim().toLowerCase();
      const sc = parseScore(m.risultato);
      if (!sc) return;

      // gol lato Corbiolo
      const corbHome = home===CORB;
      const gf = corbHome ? sc.gh : sc.ga;
      const ga = corbHome ? sc.ga : sc.gh;

      P++; GF+=gf; GA+=ga;
      if (gf>ga) V++; else if (gf===ga) N++; else S++;
    });

    const diff = GF-GA;
    document.getElementById('kPartite').textContent = P;
    document.getElementById('kVittorie').textContent = V;
    document.getElementById('kPareggi').textContent = N;
    document.getElementById('kSconfitte').textContent = S;
    document.getElementById('kFatti').textContent = GF;
    document.getElementById('kSubiti').textContent = GA;
    document.getElementById('kDiff').textContent = (diff>=0?'+':'') + diff;

    const formWrap = document.getElementById('formDots');
    formWrap.innerHTML = recent.map(m=>{
      const home = (m.casa||'').trim().toLowerCase();
      const sc = parseScore(m.risultato);
      const gf = home===CORB ? sc.gh : sc.ga;
      const ga = home===CORB ? sc.ga : sc.gh;
      const type = gf>ga ? 'fW' : (gf===ga ? 'fD' : 'fL');
      const label = gf>ga ? 'V' : (gf===ga ? 'P' : 'S');
      return `<span class="form-dot ${type}">${label}</span>`;
    }).join('');

    // Stagione label (set/ott -> giu)
    const now = new Date();
    const y = now.getMonth()>=7 ? now.getFullYear() : now.getFullYear()-1; // stagione che inizia nell'autunno precedente
    document.getElementById('seasonLabel').textContent = `Stagione ${String(y).slice(-2)}/${String(y+1).slice(-2)}`;

    // ---- LISTA PARTITE GIOCATE (ordina dalla pi√π recente)
    const out = document.getElementById('played');
    const rows = [...played].sort((a,b)=> b.date - a.date).map(m=>{
      const homeName = (m.casa||'Corbiolo').trim();
      const awayName = (m.fuori||'Avversario').trim();
      const sc = parseScore(m.risultato)||{gh:'-',ga:'-'};

      const corbHome = homeName.toLowerCase()=== 'corbiolo';
      const leftName  = corbHome ? homeName : awayName;
      const rightName = corbHome ? awayName : homeName;

      const leftLogo  = (leftName.toLowerCase()==='corbiolo') ? logoCorb : (m.logo_casa || m.logo_fuori || logoAvv);
      const rightLogo = (rightName.toLowerCase()==='corbiolo') ? logoCorb : (m.logo_fuori || m.logo_casa || logoAvv);

      const scoreTxt = corbHome ? `${sc.gh} - ${sc.ga}` : `${sc.ga} - ${sc.gh}`;

      const day = fmtDay(m.date);

      return `
        <div class="match-row">
          <div class="team">
            <img class="logo" src="${leftLogo}" onerror="this.src='${logoAvv}'" alt="">
            <div class="name">${leftName}</div>
          </div>
          <div class="score-badge">${scoreTxt}</div>
          <div class="team">
            <img class="logo" src="${rightLogo}" onerror="this.src='${logoAvv}'" alt="">
            <div class="name">${rightName}</div>
          </div>
          <div class="small muted" style="grid-column:1/-1;text-align:center;margin-top:6px">${day}</div>
        </div>
      `;
    }).join('');

    out.innerHTML = rows || '<div class="small">Nessuna partita giocata.</div>';

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>
