<!doctype html>
<html lang="it"><head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Risultati - CORB</title>
<link rel="manifest" href="manifest.json"><meta name="theme-color" content="#6b0f1a">
<link rel="apple-touch-icon" href="img/icons/icon-192.png"><meta name="apple-mobile-web-app-capable" content="yes">
<link rel="stylesheet" href="./style.css?v=22"></head>
<body>
<header class="topbar"><div class="nav"><a href="./index.html" style="color:#fff">←</a><div class="title">Risultati</div></div>
<div class="right"><button id="menuBtn" class="iconbtn" aria-label="Menu" title="Menu"><svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round"><path d="M3 6h18M3 12h18M3 18h18"/></svg></button></div></header>
<nav id="drawer"><span id="drawer-close">✕</span><h3>Menu</h3>
<a href="./news.html">📰 News</a><a href="./squadra.html">👥 Squadra</a><a href="./video.html">🎥 Video</a>
<a href="./prossima.html">📅 Prossima partita</a><a href="./partite.html">🏆 Risultati</a><a href="./calendario.html">📆 Calendario</a><a href="./admin.html">⚙️ Admin</a></nav>
<script>(function(){const d=document,dr=d.getElementById('drawer'),b=d.getElementById('menuBtn'),x=d.getElementById('drawer-close');b&&b.addEventListener('click',e=>{e.stopPropagation();dr.classList.add('open')});x&&x.addEventListener('click',()=>dr.classList.remove('open'));d.addEventListener('click',e=>{if(dr.classList.contains('open')&&!dr.contains(e.target)&&e.target!==b)dr.classList.remove('open')});})();</script>

<main class="container">
  <section class="stat-wrap">
    <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:10px">
      <h2 style="margin:0">Statistiche Stagione</h2>
      <div class="small" id="stagione">Stagione –</div>
    </div>
    <div class="stat-grid-4">
      <div class="stat-cell"><div>⚽ Partite</div><div class="stat-num" id="st-partite">0</div></div>
      <div class="stat-cell"><div>🏆 Vittorie</div><div class="stat-num" id="st-vittorie">0</div></div>
      <div class="stat-cell"><div>➖ Pareggi</div><div class="stat-num" id="st-pareggi">0</div></div>
      <div class="stat-cell"><div>✖️ Sconfitte</div><div class="stat-num" id="st-sconfitte">0</div></div>
    </div>
    <div class="stat-grid-3">
      <div class="stat-cell"><div>Gol Fatti</div><div class="stat-num" id="st-gf">0</div></div>
      <div class="stat-cell"><div>Gol Subiti</div><div class="stat-num" id="st-gs">0</div></div>
      <div class="stat-cell"><div>± Differenza</div><div class="stat-num" id="st-diff">0</div></div>
    </div>
    <div class="row small" style="margin-top:10px">Forma Attuale: <span id="forma" class="row"></span></div>
  </section>

  <section class="card"><h2 style="margin:0 0 8px 0">Risultati recenti</h2><div id="resList"></div></section>
</main>

<script type="module">
  import {get} from './data-store.js';
  const CORB='img/logo_c5.png', AVV='img/logo_avv.png';
  const parseScore = s => {
    const m=String(s||'').match(/(\d+)\s*[-:]\s*(\d+)/);
    return m?{a:+m[1],b:+m[2]}:null;
  };
  const isHome = m => (m.casa||'').trim().toLowerCase()==='corbiolo';
  const teamLogo=(m,side)=>{
    if(side==='left'){ const name=isHome(m)?'corbiolo':(m.casa||'').toLowerCase(); if(name==='corbiolo')return CORB; return m.logocasa||m.logo_casa||AVV; }
    const name=isHome(m)?(m.fuori||'').toLowerCase():'corbiolo'; if(name==='corbiolo')return CORB; return m.logoavv||m.logo_fuori||AVV;
  };
  const all = (get('partite')||[]).map(m=>({...m,date:new Date((m.data||'')+'T'+(m.ora||'00:00'))}))
               .filter(m=>!isNaN(+m.date)).sort((a,b)=>b.date-a.date);
  const played = all.filter(m=>parseScore(m.risultato));
  // stats
  const gf = played.reduce((s,m)=>s+(isHome(m)?parseScore(m.risultato).a:parseScore(m.risultato).b),0);
  const gs = played.reduce((s,m)=>s+(isHome(m)?parseScore(m.risultato).b:parseScore(m.risultato).a),0);
  let W=0,D=0,L=0; played.forEach(m=>{const sc=parseScore(m.risultato); const my=isHome(m)?sc.a:sc.b; const op=isHome(m)?sc.b:sc.a; if(my>op)W++; else if(my<op)L++; else D++;});
  document.getElementById('st-partite').textContent=played.length;
  document.getElementById('st-vittorie').textContent=W;
  document.getElementById('st-pareggi').textContent=D;
  document.getElementById('st-sconfitte').textContent=L;
  document.getElementById('st-gf').textContent=gf;
  document.getElementById('st-gs').textContent=gs;
  document.getElementById('st-diff').textContent=(gf-gs>0?'+':'')+(gf-gs);

  // stagione (set -> giu)
  const today=new Date(), y=today.getMonth()>=8?today.getFullYear():today.getFullYear()-1;
  document.getElementById('stagione').textContent=`Stagione ${String(y).slice(2)}/${String(y+1).slice(2)}`;

  // forma (ultimi 5)
  const forma = played.slice(0,5).map(m=>{
    const sc=parseScore(m.risultato); const my=isHome(m)?sc.a:sc.b; const op=isHome(m)?sc.b:sc.a;
    return my>op?'V':(my<op?'S':'P');
  });
  document.getElementById('forma').innerHTML = forma.map(ch=>{
    const cls = ch==='V'?'badge-green':(ch==='S'?'badge-red':'badge-amber');
    return `<span class="badge ${cls}">${ch}</span>`;
  }).join('');

  // lista risultati (solo già giocati, ordine dal più recente)
  const resList=document.getElementById('resList');
  resList.innerHTML = played.map(m=>{
    const sc=parseScore(m.risultato)||{a:0,b:0};
    const left  = isHome(m)?'Corbiolo':(m.casa||'');
    const right = isHome(m)?(m.fuori||''):'Corbiolo';
    const ds = m.date.toLocaleDateString(undefined,{day:'2-digit',month:'2-digit',year:'numeric'});
    const score = isHome(m)?`${sc.a} - ${sc.b}`:`${sc.b} - ${sc.a}`;
    const esito = sc.a===sc.b?'Pareggio':( (isHome(m)?sc.a:sc.b)>(isHome(m)?sc.b:sc.a) ? 'Vittoria':'Sconfitta');
    const badge = esito==='Vittoria'?'badge-green':(esito==='Sconfitta'?'badge-red':'badge-amber');
    return `<div class="card" style="margin-bottom:12px">
      <div class="small">Serie A Futsal</div>
      <div class="row" style="justify-content:space-between;align-items:center">
        <div class="row">
          <span class="team-badge"><img src="${teamLogo(m,'left')}" alt=""></span>
          <strong>${left}</strong>
        </div>
        <div class="score">${score}</div>
        <div class="row">
          <strong>${right}</strong>
          <span class="team-badge"><img src="${teamLogo(m,'right')}" alt=""></span>
        </div>
      </div>
      <div class="row small" style="justify-content:space-between;margin-top:8px">
        <span>${isHome(m)?'Casa':'Trasferta'} · ${ds}</span>
        <span class="badge ${badge}">${esito.toUpperCase()}</span>
      </div>
    </div>`;
  }).join('') || '<div class="small">Nessun risultato</div>';

  if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
</script>
</body></html>
