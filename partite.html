<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Risultati - CORB</title>

  <!-- PWA / Icons -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="img/logo_c5.png">

  <!-- CSS -->
  <link rel="stylesheet" href="./style.css?v=33">
</head>
<body>
  <!-- Topbar comune -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" class="brand" aria-label="Home">
        <img src="img/logo_c5.png" alt="Corbiolo" class="brand-logo">
        <span class="title">Risultati</span>
      </a>
    </div>
    <div class="right">
      <button data-role="menu-btn" class="iconbtn" aria-label="Apri menu" title="Menu">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Drawer comune -->
  <nav class="drawer" data-role="drawer" aria-label="Menu laterale">
    <button class="drawer-close" data-role="drawer-close" aria-label="Chiudi">✕</button>
    <h3>Menu</h3>
    <a href="./index.html">🏠 Home</a>
    <a href="./news.html">📰 News</a>
    <a href="./squadra.html">👥 Squadra</a>
    <a href="./video.html">🎥 Video</a>
    <a href="./prossima.html">📅 Prossima partita</a>
    <a href="./partite.html">🏆 Risultati</a>
    <a href="./calendario.html">📆 Calendario</a>
    <a href="./admin.html">⚙️ Admin</a>
  </nav>

  <main class="container">
    <!-- Statistiche stagione -->
    <section class="stat-card">
      <div class="stat-head">
        <div class="stat-title">
          <span class="ico">📊</span>
          <span>Statistiche stagione</span>
        </div>
        <div class="stat-range" id="seasonLabel">Stagione —</div>
      </div>

      <!-- 4 KPI in fila -->
      <div class="kpi-mini">
        <div class="mini">
          <div class="ico">✅</div>
          <div class="val" id="kpiW">0</div>
          <div class="lbl">Vittorie</div>
        </div>
        <div class="mini">
          <div class="ico">➖</div>
          <div class="val" id="kpiD">0</div>
          <div class="lbl">Pareggi</div>
        </div>
        <div class="mini">
          <div class="ico">❌</div>
          <div class="val" id="kpiL">0</div>
          <div class="lbl">Sconfitte</div>
        </div>
        <div class="mini">
          <div class="ico">🏅</div>
          <div class="val" id="kpiPts">0</div>
          <div class="lbl">Punti</div>
        </div>
      </div>

      <!-- 3 box: gol fatti, subiti, diff -->
      <div class="kpi-big">
        <div class="big">
          <div class="ico">⚽️</div>
          <div class="val" id="kpiGF">0</div>
          <div class="lbl">Gol fatti</div>
        </div>
        <div class="big">
          <div class="ico">🛡️</div>
          <div class="val" id="kpiGA">0</div>
          <div class="lbl">Gol subiti</div>
        </div>
        <div class="big">
          <div class="ico">➗</div>
          <div class="val" id="kpiGD">0</div>
          <div class="lbl">Differenza reti</div>
        </div>
      </div>

      <!-- Form W/D/L -->
      <div class="form-wrap" id="formWrap" title="Ultime gare"></div>
    </section>

    <!-- Lista risultati -->
    <section class="card">
      <h2 style="margin:0 0 8px 0">Tutte le partite giocate</h2>
      <div id="resultsList"></div>
    </section>

    <!-- Ultimo sync -->
    <section class="card small">
      Ultimo aggiornamento dati: <span id="ls">never</span>
    </section>
  </main>

  <script type="module">
    import { last, get } from './data-store.js';

    // ==== MENU (apri/chiudi) ====
    const drawer   = document.querySelector('[data-role="drawer"]');
    const menuBtn  = document.querySelector('[data-role="menu-btn"]');
    const closeBtn = document.querySelector('[data-role="drawer-close"]');
    function openDrawer(){ drawer?.classList.add('open'); }
    function closeDrawer(){ drawer?.classList.remove('open'); }
    menuBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); openDrawer(); });
    closeBtn?.addEventListener('click', closeDrawer);
    document.addEventListener('click', (e)=> {
      if (drawer?.classList.contains('open') && !drawer.contains(e.target) && e.target!==menuBtn) closeDrawer();
    });

    // ==== Helpers ====
    const CORB = 'corbiolo';
    const now = new Date();

    const toDate = (d, t='00:00') => {
      if (!d) return new Date('Invalid');
      if (/^\d{4}-\d{2}-\d{2}/.test(d)) return new Date(d + 'T' + t);
      const m = d.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (m){ const dd=+m[1], mm=+m[2]-1, yy=(+m[3]<100?2000+ +m[3]:+m[3]); return new Date(yy,mm,dd); }
      return new Date(d + 'T' + t);
    };
    const fmtShort = d => d.toLocaleDateString(undefined, { day:'2-digit', month:'short', year:'numeric' });

    function parseScore(res=''){
      // accetta "2-1", "2 – 1", "2 : 1"
      const m = res.toString().match(/(-?\d+)\s*[-–:]\s*(-?\d+)/);
      return m ? {h:+m[1], a:+m[2]} : null;
    }

    function seasonLabel(baseDate=new Date()){
      const y = baseDate.getFullYear();
      const m = baseDate.getMonth(); // 0-11
      const start = (m >= 7) ? y : (y-1);      // stagione parte ad agosto (7)
      const end   = start + 1;
      return `Stagione ${String(start).slice(2)}/${String(end).slice(2)}`;
    }

    // ==== Dati ====
    document.getElementById('ls').textContent = last();
    document.getElementById('seasonLabel').textContent = seasonLabel(now);

    // Dal localStorage (popolato da admin)
    const raw = (get('matches') || []);
    const all = raw.map(m => ({
      ...m,
      date: toDate(m.data || '', m.ora || '00:00'),
      casa: (m.casa||'').trim(),
      fuori:(m.fuori||'').trim(),
      risultato: (m.risultato||'').trim(),
      logo_casa: (m.logo_casa||'').trim(),
      logo_avv:  (m.logo_avv||m.logo_fuori||'').trim(),
    })).filter(m => !isNaN(+m.date));

    // Solo giocate: con risultato **oppure** data <= now
    const played = all.filter(m => m.risultato || m.date <= now)
                      .sort((a,b) => b.date - a.date);  // ultimo in alto

    // ==== Statistiche ====
    let W=0,D=0,L=0, GF=0, GA=0;
    const form = []; // ultime 5
    for (const m of played){
      const homeSide = m.casa.toLowerCase() === CORB;
      const s = parseScore(m.risultato);
      if (!s) continue;
      const gf = homeSide ? s.h : s.a;
      const ga = homeSide ? s.a : s.h;
      GF += gf; GA += ga;
      if (gf > ga){ W++; form.push('W'); }
      else if (gf === ga){ D++; form.push('D'); }
      else { L++; form.push('L'); }
    }
    const PTS = W*3 + D*1;
    const GD  = GF - GA;

    // Stampa KPI
    const $ = (id)=>document.getElementById(id);
    $('kpiW').textContent = W;
    $('kpiD').textContent = D;
    $('kpiL').textContent = L;
    $('kpiPts').textContent= PTS;
    $('kpiGF').textContent = GF;
    $('kpiGA').textContent = GA;
    $('kpiGD').textContent = (GD>0?'+':'') + GD;

    // Form ultime 5
    const formWrap = document.getElementById('formWrap');
    const last5 = form.slice(0,5);
    formWrap.innerHTML = last5.map(c => {
      const cls = c==='W'?'fW':(c==='D'?'fD':'fL');
      const label = c==='W'?'V':(c==='D'?'P':'S');
      return `<span class="form-dot ${cls}">${label}</span>`;
    }).join('');

    // ==== Rendering lista partite ====
    const list = document.getElementById('resultsList');

    function logoFor(name, provided){
      if (name.toLowerCase() === CORB) return 'img/logo_c5.png';
      if (provided) return provided;
      return 'img/logo_avv.png';
    }

    function rowCard(m){
      const homeSide = m.casa.toLowerCase() === CORB;
      const leftTeam  = homeSide ? m.casa : m.fuori;
      const rightTeam = homeSide ? m.fuori : m.casa;

      const leftLogo  = homeSide ? logoFor(m.casa, m.logo_casa) : logoFor(m.fuori, m.logo_avv);
      const rightLogo = homeSide ? logoFor(m.fuori, m.logo_avv) : logoFor(m.casa, m.logo_casa);

      const icon = homeSide ? '🏠' : '✈️';
      const when = fmtShort(m.date);
      const score = (m.risultato || '–').replace('-', ' - ');

      return `
        <article class="player" style="align-items:center">
          <div class="row" style="gap:10px;align-items:center">
            <img src="${leftLogo}" alt="" style="width:40px;height:40px;border-radius:8px;border:none;object-fit:cover">
            <div style="min-width:90px;font-weight:700">${leftTeam}</div>
          </div>

          <div class="score" style="width:64px;height:48px;font-size:18px">${score}</div>

          <div class="row" style="gap:10px;align-items:center">
            <div style="min-width:90px;text-align:right;font-weight:700">${rightTeam}</div>
            <img src="${rightLogo}" alt="" style="width:40px;height:40px;border-radius:8px;border:none;object-fit:cover">
          </div>
        </article>
        <div class="row" style="justify-content:space-between;margin:-6px 0 12px 0">
          <div class="small">${when}</div>
          <span class="pill">${icon} ${homeSide?'Casa':'Trasferta'}</span>
        </div>
      `;
    }

    list.innerHTML = played.length
      ? played.map(rowCard).join('')
      : `<div class="small">Nessuna partita giocata</div>`;

    // SW
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>

  <!-- JS menu comune (opzionale se già incluso altrove) -->
  <script src="./ui.js?v=33"></script>
</body>
</html>
