<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Risultati - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css">
</head>
<body>
  <!-- Barra superiore -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" style="color:#fff">‚Üê</a>
      <div class="title" style="font-weight:700;margin-left:8px">Risultati</div>
    </div>
    <div class="right">
      <a class="iconbtn" href="./admin.html">‚ü≥</a>
    </div>
  </header>

  <!-- Filtri -->
  <main class="container">
    <section class="card">
      <div class="search">
        <span>üîé</span>
        <input id="q" placeholder="Cerca partite, squadre o competizioni...">
      </div>
      <div class="chips" id="comp" style="margin-top:10px">
        <span class="chip active" data-comp="">Tutte</span>
        <span class="chip" data-comp="Serie A Futsal">Serie A Futsal</span>
        <span class="chip" data-comp="Coppa Italia Futsal">Coppa Italia Futsal</span>
      </div>
    </section>

    <!-- Lista partite -->
    <section id="list"></section>
  </main>

  <!-- Script -->
  <script type="module">
    import {get} from './data-store.js';

    // Parsing data/ora robusto
    function toDate(d, t='00:00') {
      if (!d) return new Date('Invalid');
      // supporta sia YYYY-MM-DD che DD/MM/YYYY
      if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return new Date(`${d}T${t}`);
      const m = d.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (m) {
        const dd = +m[1], mm = +m[2]-1, yy = (+m[3] < 100 ? 2000 + +m[3] : +m[3]);
        const [hh='00', mi='00'] = (t||'00:00').split(':');
        return new Date(yy, mm, dd, +hh||0, +mi||0);
      }
      return new Date(`${d}T${t}`);
    }

    const now = new Date();

    // Prepara dataset: solo partite gi√† giocate (data <= adesso)
    const raw = get('matches') || [];
    const data = raw.map(m => ({
      ...m,
      date: toDate(m.data, m.ora),
      competizione: m.competizione || 'Serie A Futsal'
    }))
    .filter(m => !isNaN(+m.date) && m.date <= now) // <-- esclude future
    .sort((a,b) => b.date - a.date);               // <-- dalla pi√π recente

    const list = document.getElementById('list');

    function resultBadge(m) {
      const r = (m.risultato || '').trim();
      if (!r) return '';
      const parts = r.match(/(\d+)\D+(\d+)/);
      if (!parts) return '';
      const a = +parts[1], b = +parts[2];
      if (a > b) return '<span class="badge badge-green">VITTORIA</span>';
      if (a < b) return '<span class="badge badge-red">SCONFITTA</span>';
      return '<span class="badge badge-amber">PAREGGIO</span>';
    }

    function card(m) {
      const when = m.date.toLocaleDateString(undefined, {day:'2-digit',month:'2-digit',year:'numeric'});
      const home = m.casa || 'Corbiolo';
      const away = m.fuori || '';
      return `
        <article class="card" style="display:grid;gap:10px">
          <div>
            <div class="small">${m.competizione}</div>
            <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:10px">
              <div><strong>${home}</strong><div class="small">Casa</div></div>
              <div class="score">${(m.risultato || '‚Äì').replace('-', ' - ')}</div>
              <div style="text-align:right"><strong>${away}</strong><div class="small">Trasferta</div></div>
            </div>
            <div class="row" style="justify-content:space-between;margin-top:6px">
              ${resultBadge(m)}
              <div class="small">${when}</div>
            </div>
          </div>
        </article>`;
    }

    function apply() {
      const q = (document.getElementById('q').value || '').toLowerCase();
      const comp = document.querySelector('#comp .chip.active')?.dataset.comp || '';
      const rows = data.filter(m =>
        (comp === '' || m.competizione === comp) &&
        (`${m.casa} ${m.fuori} ${m.risultato} ${m.competizione}`.toLowerCase().includes(q))
      );
      list.innerHTML = rows.length ? rows.map(card).join('') : '<div class="card">Nessun risultato</div>';
    }

    // Eventi
    document.getElementById('q').addEventListener('input', apply);
    document.querySelectorAll('#comp .chip').forEach(chip => {
      chip.addEventListener('click', () => {
        chip.parentElement.querySelectorAll('.chip').forEach(x => x.classList.remove('active'));
        chip.classList.add('active');
        apply();
      });
    });

    // Render iniziale
    apply();

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }
  </script>
</body>
</html>
