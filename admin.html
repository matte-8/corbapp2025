<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin - CORB</title>

  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="img/logo_c5.png">

  <link rel="stylesheet" href="./style.css?v=33">
  <style>
    .admin-wrap{display:grid;gap:16px}
    .field{display:grid;gap:6px}
    .field input{border:1px solid var(--ring);border-radius:12px;padding:10px 12px;background:#fff}
    .grid-2-admin{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:700px){.grid-2-admin{grid-template-columns:1fr}}
    .btn{border:1px solid var(--ring);background:#fff;border-radius:12px;padding:10px 14px;font-weight:800;display:inline-flex;gap:8px;align-items:center;cursor:pointer}
    .btn-primary{background:var(--granata);color:#fff;border-color:transparent}
    .log{background:#0b1020;color:#cde;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, monospace;padding:12px;border-radius:12px;max-height:240px;overflow:auto;font-size:12px}
    .ok{color:#10b981}.err{color:#ef4444}.muted{opacity:.85}
    .login-card{display:grid;gap:12px}
    .login-card input{border:1px solid var(--ring);border-radius:12px;padding:10px 12px;background:#fff}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" class="brand" aria-label="Home">
        <img src="img/logo_c5.png" alt="Corbiolo" class="brand-logo">
        <span class="title">Admin</span>
      </a>
    </div>
    <div class="right">
      <button data-role="menu-btn" class="iconbtn" aria-label="Apri menu" title="Menu">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Drawer -->
  <nav class="drawer" data-role="drawer" aria-label="Menu laterale">
    <button class="drawer-close" data-role="drawer-close" aria-label="Chiudi">‚úï</button>
    <h3>Menu</h3>
    <a href="./index.html">üè† Home</a>
    <a href="./news.html">üì∞ News</a>
    <a href="./squadra.html">üë• Squadra</a>
    <a href="./video.html">üé• Video</a>
    <a href="./prossima.html">üìÖ Prossima partita</a>
    <a href="./partite.html">üèÜ Risultati</a>
    <a href="./calendario.html">üìÜ Calendario</a>
    <a href="./admin.html">‚öôÔ∏è Admin</a>
  </nav>

  <main class="container">
    <!-- LOGIN -->
    <section class="card" id="loginCard">
      <h2 style="margin:0 0 8px 0">Accesso amministratore</h2>
      <div class="login-card">
        <label class="field">
          <span>Password</span>
          <input id="pwd" type="password" placeholder="Inserisci password"/>
        </label>
        <button id="loginBtn" class="btn btn-primary">Entra</button>
        <div class="small muted">Password: <code>corb25</code></div>
      </div>
    </section>

    <!-- PANNELLO -->
    <section class="card admin-wrap" id="panel" style="display:none">
      <h2 style="margin:0">Impostazioni e sincronizzazione</h2>

      <div class="grid-2-admin">
        <label class="field">
          <span>Google Sheet ID</span>
          <input id="sheetId" placeholder="ID del tuo Spreadsheet"/>
        </label>
        <label class="field">
          <span>Formato esportazione</span>
          <input value="CSV (Google export)" disabled/>
        </label>
      </div>

      <div class="grid-2-admin">
        <label class="field"><span>GID Partite</span><input id="gid_matches" placeholder="es. 1408482393"/></label>
        <label class="field"><span>GID Calendario</span><input id="gid_calendar" placeholder="es. 0"/></label>
      </div>
      <div class="grid-2-admin">
        <label class="field"><span>GID News</span><input id="gid_news" placeholder="es. 1118175028"/></label>
        <label class="field"><span>GID Giocatori</span><input id="gid_players" placeholder=""/></label>
      </div>
      <div class="grid-2-admin">
        <label class="field"><span>GID Video</span><input id="gid_videos" placeholder=""/></label>
        <div></div>
      </div>

      <div class="row" style="justify-content:flex-start">
        <button id="saveCfg" class="btn">üíæ Salva impostazioni</button>
        <button id="syncBtn" class="btn btn-primary">üîÑ Aggiorna adesso</button>
      </div>

      <div class="small">Ultimo aggiornamento: <span id="lastSync">never</span></div>
      <div class="log" id="log" aria-live="polite"></div>
    </section>
  </main>

  <script type="module">
    // ===== MENU =====
    const drawer   = document.querySelector('[data-role="drawer"]');
    const menuBtn  = document.querySelector('[data-role="menu-btn"]');
    const closeBtn = document.querySelector('[data-role="drawer-close"]');
    function openDrawer(){ drawer?.classList.add('open'); }
    function closeDrawer(){ drawer?.classList.remove('open'); }
    menuBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); openDrawer(); });
    closeBtn?.addEventListener('click', closeDrawer);
    document.addEventListener('click', (e)=> {
      if (drawer?.classList.contains('open') && !drawer.contains(e.target) && e.target!==menuBtn) closeDrawer();
    });

    // ===== CONFIG =====
    const DFLT = {
      sheetId: '143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I',
      gid_matches:  '1730522931',   // Partite ‚úÖ
      gid_calendar: '787175543',            // Calendario (se diverso, incolla il tuo)
      gid_news:     '1408482393',   // News ‚úÖ
      gid_players:  '706688113',             // prender√† da localStorage se gi√† salvato
      gid_videos:   '1118175028'              // prender√† da localStorage se gi√† salvato
    };
    const CFG_KEY = 'corb_cfg';
    const LAST_KEY = 'lastSync';

    const $ = (id)=>document.getElementById(id);
    const log = (msg, cls='muted') => {
      const el = $('log'); el.innerHTML += `<div class="${cls}">${msg}</div>`;
      el.scrollTop = el.scrollHeight;
    };

    function loadCfg(){
      const saved = localStorage.getItem(CFG_KEY);
      if (!saved) return {...DFLT};
      try {
        const parsed = JSON.parse(saved);
        // merge con DFLT per garantire i valori noti
        return {...DFLT, ...parsed};
      } catch { return {...DFLT}; }
    }
    function saveCfg(cfg){
      localStorage.setItem(CFG_KEY, JSON.stringify(cfg));
    }

    // ===== LOGIN =====
    const PASS = 'corb25';
    const loginCard = $('loginCard');
    const panel = $('panel');
    $('loginBtn').addEventListener('click', ()=>{
      if ($('pwd').value !== PASS){ alert('Password errata'); return; }
      loginCard.style.display='none';
      panel.style.display='grid';
      initPanel();
    });

    // ===== CSV ‚Üí JSON =====
    function parseCSV(text){
      const rows = [];
      let i=0, field='', row=[], inq=false;
      const pushField = () => { row.push(field); field=''; };
      const pushRow   = () => { rows.push(row); row=[]; };
      while (i < text.length){
        const c = text[i];
        if (inq){
          if (c === '"'){ if (text[i+1] === '"'){ field += '"'; i++; } else { inq = false; } }
          else { field += c; }
        } else {
          if (c === '"'){ inq = true; }
          else if (c === ','){ pushField(); }
          else if (c === '\n'){ pushField(); pushRow(); }
          else if (c === '\r'){ /* skip */ }
          else { field += c; }
        }
        i++;
      }
      if (field.length || row.length){ pushField(); pushRow(); }
      const [hdr, ...data] = rows.filter(r => r.length && r.join('').trim().length);
      if (!hdr) return [];
      const keys = hdr.map(h => h.trim().toLowerCase());
      return data.map(r => {
        const obj = {};
        for (let k=0;k<keys.length;k++){ obj[keys[k]] = (r[k] ?? '').toString().trim(); }
        return obj;
      });
    }

    async function fetchGSheetCSV(sheetId, gid){
      const url = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
      const res = await fetch(url, {cache:'no-store'});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const text = await res.text();
      return parseCSV(text);
    }

    // ===== SYNC =====
    async function syncAll(){
      const cfg = currentCfg();
      log('Inizio aggiornamento‚Ä¶');

      try{
        log('Scarico PARTITE‚Ä¶');
        const matches = await fetchGSheetCSV(cfg.sheetId, cfg.gid_matches);
        localStorage.setItem('matches', JSON.stringify(matches));
        log(`<b class="ok">‚úî Partite (${matches.length})</b>`, 'ok');

        if (cfg.gid_calendar){
          log('Scarico CALENDARIO‚Ä¶');
          const calendar = await fetchGSheetCSV(cfg.sheetId, cfg.gid_calendar);
          localStorage.setItem('calendar', JSON.stringify(calendar));
          log(`<b class="ok">‚úî Calendario (${calendar.length})</b>`, 'ok');
        }

        log('Scarico NEWS‚Ä¶');
        const news = await fetchGSheetCSV(cfg.sheetId, cfg.gid_news);
        localStorage.setItem('news', JSON.stringify(news));
        log(`<b class="ok">‚úî News (${news.length})</b>`, 'ok');

        if (cfg.gid_players){
          log('Scarico GIOCATORI‚Ä¶');
          const players = await fetchGSheetCSV(cfg.sheetId, cfg.gid_players);
          localStorage.setItem('giocatori', JSON.stringify(players));
          log(`<b class="ok">‚úî Giocatori (${players.length})</b>`, 'ok');
        }

        if (cfg.gid_videos){
          log('Scarico VIDEO‚Ä¶');
          const videos = await fetchGSheetCSV(cfg.sheetId, cfg.gid_videos);
          localStorage.setItem('video', JSON.stringify(videos));
          log(`<b class="ok">‚úî Video (${videos.length})</b>`, 'ok');
        }

        const ts = new Date().toISOString();
        localStorage.setItem(LAST_KEY, ts);
        $('lastSync').textContent = new Date(ts).toLocaleString();
        log(`<b class="ok">‚úî Completato alle ${$('lastSync').textContent}</b>`, 'ok');

        try{
          const bc = new BroadcastChannel('corb-sync');
          bc.postMessage({type:'data-updated', at: ts});
          bc.close();
        }catch(e){}

        alert('Aggiornamento completato!');
      }catch(err){
        console.error(err);
        log(`<b class="err">‚úñ Errore: ${err.message}</b>`, 'err');
        alert('Errore durante l‚Äôaggiornamento. Riprova.');
      }
    }

    // ===== UI pannello =====
    function currentCfg(){
      return {
        sheetId: $('sheetId').value.trim(),
        gid_matches: $('gid_matches').value.trim(),
        gid_calendar:$('gid_calendar').value.trim(),
        gid_news:    $('gid_news').value.trim(),
        gid_players: $('gid_players').value.trim(),
        gid_videos:  $('gid_videos').value.trim()
      };
    }
    function initPanel(){
      const cfg = loadCfg();
      $('sheetId').value     = cfg.sheetId;
      $('gid_matches').value = cfg.gid_matches;
      $('gid_calendar').value= cfg.gid_calendar;
      $('gid_news').value    = cfg.gid_news;
      $('gid_players').value = cfg.gid_players;
      $('gid_videos').value  = cfg.gid_videos;

      const last = localStorage.getItem('lastSync');
      $('lastSync').textContent = last ? new Date(last).toLocaleString() : 'never';

      $('saveCfg').onclick = ()=>{ saveCfg(currentCfg()); log('<b class="ok">‚úî Impostazioni salvate</b>','ok'); };
      $('syncBtn').onclick = ()=>{ saveCfg(currentCfg()); syncAll(); };
    }
  </script>

  <!-- JS menu comune -->
  <script src="./ui.js?v=33"></script>
</body>
</html>
