<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css">
  <style>
    .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--ring);background:#fff;cursor:pointer}
    .btn.primary{background:#6b0f1a;color:#fff;border-color:#6b0f1a}
    .log{white-space:pre-wrap;font-family:ui-monospace,monospace;background:#fff;border:1px solid var(--ring);border-radius:12px;padding:10px;max-height:220px;overflow:auto}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" style="color:#fff">‚Üê</a>
      <div class="title" style="font-weight:700;margin-left:8px">Admin</div>
    </div>
    <div class="right">
      <a class="iconbtn" href="./index.html" title="Home">üè†</a>
    </div>
  </header>

  <main class="container">
    <!-- Login PIN -->
    <section class="card">
      <h1>Area Admin</h1>
      <p class="small">Inserisci PIN per sbloccare i comandi.</p>
      <div class="row">
        <input id="pin" class="search" placeholder="PIN" style="max-width:220px">
        <button id="go" class="btn">Entra</button>
        <span id="status" class="small"></span>
      </div>
    </section>

    <!-- Pannello -->
    <section class="card" id="panel" style="display:none">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">Sincronizzazione</h2>
        <div class="small">Ultimo sync: <span id="ls">never</span></div>
      </div>

      <div class="row" style="margin-top:10px">
        <button id="syncAll" class="btn primary">‚ü≥ Aggiorna TUTTO</button>
        <button id="clear" class="btn">‚úï Svuota cache</button>
      </div>

      <div class="section" style="margin-top:12px">
        <h3 class="small" style="margin:0 0 6px 0">Log</h3>
        <div id="log" class="log">Pronto.</div>
      </div>

      <p class="small" style="margin-top:10px">
        Le pagine pubbliche leggono solo dalla cache locale. Nessun aggiornamento automatico:
        i dati cambiano solo quando premi <b>Aggiorna</b>.
      </p>
    </section>
  </main>

  <script type="module">
    import { set, setLast, last, clearAll } from './data-store.js';

    // === CONFIG ===
    const PIN = 'corb25';
    const SHEET_ID = '143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I';
    // GID: news, giocatori, sponsor, partite, calendario
    const CSV = {
      news:      `https://docs.google.com/spreadsheets/d/${143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I}/export?format=csv&gid=1408482393`,
      players:   `https://docs.google.com/spreadsheets/d/${143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I}/export?format=csv&gid=706688113`,
      sponsors:  `https://docs.google.com/spreadsheets/d/${143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I}/export?format=csv&gid=1118175028`,
      matches:   `https://docs.google.com/spreadsheets/d/${143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I}/export?format=csv&gid=1730522931`,
      calendar:  `https://docs.google.com/spreadsheets/d/${143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I}/export?format=csv&gid=787175543`
    };

    // === UI refs ===
    const elPanel = document.getElementById('panel');
    const elLS = document.getElementById('ls');
    const elLog = document.getElementById('log');
    const log = (m) => { elLog.textContent += '\\n' + m; elLog.scrollTop = elLog.scrollHeight; };

    // CSV robust parser (comma inside quotes)
    const parseCSV = (txt) => {
      const lines = txt.replace(/\r/g,'').split('\n').filter(x=>x.trim().length);
      if (!lines.length) return [];
      const headers = splitCSVLine(lines[0]).map(h=>h.trim().toLowerCase());
      return lines.slice(1).map(line => {
        const cells = splitCSVLine(line);
        const obj = {};
        headers.forEach((h,i)=> obj[h] = (cells[i] ?? '').replace(/^"|"$/g,''));
        return obj;
      });
    };
    function splitCSVLine(line) {
      const out = []; let cur = ''; let q = false;
      for (let i=0;i<line.length;i++){
        const ch = line[i];
        if (ch === '"'){ q = !q; cur += ch; }
        else if (ch === ',' && !q){ out.push(cur); cur=''; }
        else { cur += ch; }
      }
      out.push(cur);
      return out;
    }

    async function pull(key, mapTo, storeKey){
      const res = await fetch(CSV[key], { cache:'no-store' });
      if(!res.ok) throw new Error(`${key}: HTTP ${res.status}`);
      const rows = parseCSV(await res.text());
      const mapped = rows.map(mapTo);
      set(storeKey, mapped);
      log(`‚úî ${storeKey}: ${mapped.length} record`);
    }

    async function syncAll(){
      elLog.textContent = 'Avvio sync‚Ä¶';
      try{
        await Promise.all([
          pull('players',  r => ({ nome:r.nome, numero:r.numero, ruolo:r.ruolo, foto:r.foto }), 'players'),
          pull('news',     r => ({ titolo:r.titolo, contenuto:r.contenuto, img:r.img, tag:r.tag||'', nuova:(r.nuova||'')==='1' }), 'news'),
          pull('sponsors', r => ({ nome:r.nome, logo:r.logo, link:r.link }), 'sponsors'),
          pull('matches',  r => ({ data:r.data, ora:r.ora, casa:r.casa, logocasa:r.logocasa, fuori:r.fuori, logoavv:r.logoavv, risultato:r.risultato, competizione:r.competizione||'', luogo:r.luogo||'', mvp:r.mvp||'' }), 'matches'),
          pull('calendar', r => ({ data:r.data, avversario:r.avversario, casa_fuori:r.casa_fuori }), 'calendar')
        ]);
        const ts = new Date().toLocaleString();
        setLast(ts);
        elLS.textContent = ts;
        log('üéâ Fatto!');
        alert('Aggiornamento completato');
      }catch(err){
        log('‚ùå Errore: ' + (err?.message||err));
        alert('Errore durante l\'aggiornamento');
      }
    }

    // Login PIN
    document.getElementById('go').addEventListener('click', () => {
      const ok = (document.getElementById('pin').value || '').trim() === PIN;
      document.getElementById('status').textContent = ok ? 'OK' : 'PIN errato';
      elPanel.style.display = ok ? 'block' : 'none';
      elLS.textContent = last();
    });

    // Bottoni
    document.getElementById('syncAll').addEventListener('click', syncAll);
    document.getElementById('clear').addEventListener('click', () => {
      clearAll(); elLS.textContent = 'never'; elLog.textContent = 'Cache svuotata.'; alert('Cache svuotata');
    });

    // PWA
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }
  </script>
</body>
</html>
