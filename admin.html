<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Admin · CORB</title>
  <meta name="theme-color" content="#6b0f1a">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css">
  <style>
    .wrap{max-width:720px;margin:20px auto;padding:16px}
    .card{background:#fff;border:1px solid var(--ring);border-radius:16px;padding:16px;box-shadow:0 10px 30px rgba(0,0,0,.06)}
    .row{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
    .btn{padding:10px 14px;border-radius:10px;border:1px solid var(--ring);background:var(--granata);color:#fff;cursor:pointer}
    .muted{color:var(--muted)}
    .ok{color:#059669}
    .err{color:#dc2626}
    input[type=password]{padding:10px;border:1px solid var(--ring);border-radius:10px}
    .log{white-space:pre-wrap;font-family:ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;background:#faf7f8;border:1px solid var(--ring);border-radius:12px;padding:12px;max-height:220px;overflow:auto}
  </style>
  
</head>
<body>
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" style="color:#fff">←</a>
      <div class="title" style="font-weight:700;margin-left:8px">Admin</div>
    </div>
  </header>
  
  <main class="wrap">
    <section class="card">
      <h2 style="margin:0 0 10px 0">Aggiorna dati</h2>
      <div class="row" style="margin-bottom:10px">
        <input id="pwd" type="password" placeholder="Password" autocomplete="current-password">
        <button id="go" class="btn">Aggiorna adesso</button>
        <button id="clear" class="btn" style="background:#6b7280">Svuota cache locale</button>
      </div>
      <div class="small muted">Ultimo aggiornamento: <span id="ls">never</span></div>
      <div id="status" class="log" style="margin-top:12px">Pronto.</div>
    </section>

    <section class="card" style="margin-top:16px">
      <h3 style="margin:0 0 8px 0">Origine dati (Google Sheets)</h3>
      <div class="small">
        Sheet ID: <code id="sheetId">143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I</code><br>
        News GID: <code>1408482393</code> – Giocatori: <code>706688113</code> – Video: <code>1118175028</code><br>
        Partite: <code>1730522931</code> – Calendario: <code>787175543</code>
      </div>
    </section>
  </main>

  <script type="module">
    import {set, clearAll, last, setLast} from './data-store.js';

    const PASSWORD = 'corb25';
    const SHEET_ID = '143tbH2ZfTHk9bsgL1T7s6PQcSkR-HrCepz0GS--Go8I';

    // GID dalle tue schermate
    const GIDS = {
      news:       '1408482393',
      giocatori:  '706688113',
      video:      '1118175028',        // ⟵ NUOVO: tab "video"
      matches:    '1730522931',        // partite
      calendar:   '787175543'          // calendario
    };

    // Mappature CSV -> oggetti
    const mappers = {
      news: (r)=>({ titolo:r.titolo||'', contenuto:r.contenuto||'', img:r.img||'', tag:(r.nuova||'News') }),
      giocatori: (r)=>({ nome:r.nome||'', numero:r.numero||'', ruolo:r.ruolo||'', foto:r.foto||'' }),
      video: (r)=>({ nome:r.nome||'', logo:r.logo||'', link:r.link||'' }),
      matches: (r)=>({
        data:r.data||'', ora:r.ora||'',
        casa:r.casa||'', lococasa:r.lococasa||'', logoavv:r.logoavv||'',
        fuori:r.fuori||'', logoavv2:r.logoavv2||'',
        risultato:r.risultato||'', mvp:r.mvp||''
      }),
      calendar: (r)=>({ data:r.data||'', avversario:r.avversario||'', casa_fuori:(r.casa_fuori||'').toLowerCase() })
    };

    const log = (msg, cls='')=>{
      const box = document.getElementById('status');
      box.innerHTML += '\\n' + msg;
      if (cls) box.className = 'log ' + cls;
      box.scrollTop = box.scrollHeight;
    };

    const csvUrl = (gid)=>`https://docs.google.com/spreadsheets/d/${SHEET_ID}/export?format=csv&gid=${gid}`;

    async function fetchCsv(gid){
      const res = await fetch(csvUrl(gid), {cache:'no-store'});
      if (!res.ok) throw new Error('HTTP '+res.status);
      const text = await res.text();
      const [head, ...rows] = text.split(/\\r?\\n/).filter(Boolean);
      const cols = head.split(',').map(s=>s.trim());
      return rows.map(line=>{
        const vals = line.split(',').map(s=>s.trim());
        const o = {};
        cols.forEach((c,i)=> o[c] = vals[i] ?? '');
        return o;
      });
    }

    async function updateAll(){
      document.getElementById('ls').textContent = last();
      log('Avvio aggiornamento...');

      const order = ['news','giocatori','video','matches','calendar'];
      for (const key of order){
        log(`Scarico ${key}...`);
        const raw = await fetchCsv(GIDS[key]);
        const mapped = raw.map(mappers[key]);
        set(key, mapped);
        log(`✔ ${key}: ${mapped.length} record`, 'ok');
      }

      setLast(new Date().toLocaleString());
      document.getElementById('ls').textContent = last();
      log('Completato.', 'ok');
    }

    // UI
    document.getElementById('ls').textContent = last();
    document.getElementById('go').addEventListener('click', async ()=>{
      const pwd = (document.getElementById('pwd').value||'').trim();
      if (pwd !== PASSWORD){ log('Password errata.', 'err'); return; }
      try { await updateAll(); }
      catch(err){ console.error(err); log('Errore: '+err.message, 'err'); }
    });
    document.getElementById('clear').addEventListener('click', ()=>{
      clearAll(); log('Cache locale svuotata.');
      document.getElementById('ls').textContent = last();
    });
  </script>
</body>
</html>
