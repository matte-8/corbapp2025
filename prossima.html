<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Prossima partita - CORB</title>

  <!-- PWA / Icone -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="img/logo_c5.png">

  <!-- CSS -->
  <link rel="stylesheet" href="./style.css?v=33">
  <style>
    /* extra minimi pagina */
    .next-card{
      background:linear-gradient(180deg,var(--granata-2),var(--granata));
      color:#fff;border-radius:18px;padding:16px;
      box-shadow:0 10px 30px rgba(0,0,0,.14)
    }
    .teams-row{
      display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center
    }
    .logo{
      width:56px;height:56px;border-radius:12px;object-fit:cover;border:none;background:#fff;
    }
    .scorebox{
      min-width:74px;height:54px;border-radius:14px;
      background:#ffffff22;color:#fff;display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:20px
    }
    .teamname{font-weight:800}
    .meta{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .future-row{
      display:flex;justify-content:space-between;align-items:center;
      padding:10px 0;border-bottom:1px solid var(--ring)
    }
    .future-row:last-child{border-bottom:0}
  </style>
</head>
<body>
  <!-- Topbar comune -->
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" class="brand" aria-label="Home">
        <img src="img/logo_c5.png" alt="Corbiolo" class="brand-logo">
        <span class="title">Prossima partita</span>
      </a>
    </div>
    <div class="right">
      <button data-role="menu-btn" class="iconbtn" aria-label="Apri menu" title="Menu">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <!-- Drawer comune -->
  <nav class="drawer" data-role="drawer" aria-label="Menu laterale">
    <button class="drawer-close" data-role="drawer-close" aria-label="Chiudi">‚úï</button>
    <h3>Menu</h3>
    <a href="./index.html">üè† Home</a>
    <a href="./news.html">üì∞ News</a>
    <a href="./squadra.html">üë• Squadra</a>
    <a href="./video.html">üé• Video</a>
    <a href="./prossima.html">üìÖ Prossima partita</a>
    <a href="./partite.html">üèÜ Risultati</a>
    <a href="./calendario.html">üìÜ Calendario</a>
    <a href="./admin.html">‚öôÔ∏è Admin</a>
  </nav>

  <main class="container">
    <!-- Prossima in evidenza -->
    <section class="next-card" id="nextBox">
      <div class="row" style="justify-content:space-between">
        <h2 style="margin:0">La prossima</h2>
        <a class="pill" href="./calendario.html">Vedi calendario</a>
      </div>
      <div id="nextGrid" class="teams-row" style="margin-top:10px"></div>
      <div id="nextMeta" class="row small" style="margin-top:10px;opacity:.95"></div>
    </section>

    <!-- Tutte le future -->
    <section class="card">
      <h2 style="margin:0 0 8px 0">Partite future</h2>
      <div id="futureList"></div>
    </section>

    <!-- Ultimo sync -->
    <section class="card small">
      Ultimo aggiornamento dati: <span id="ls">never</span>
    </section>
  </main>

  <script type="module">
    import { last, get } from './data-store.js';

    // ==== MENU (apri/chiudi) ====
    const drawer   = document.querySelector('[data-role="drawer"]');
    const menuBtn  = document.querySelector('[data-role="menu-btn"]');
    const closeBtn = document.querySelector('[data-role="drawer-close"]');
    function openDrawer(){ drawer?.classList.add('open'); }
    function closeDrawer(){ drawer?.classList.remove('open'); }
    menuBtn?.addEventListener('click', (e)=>{ e.stopPropagation(); openDrawer(); });
    closeBtn?.addEventListener('click', closeDrawer);
    document.addEventListener('click', (e)=> {
      if (drawer?.classList.contains('open') && !drawer.contains(e.target) && e.target!==menuBtn) closeDrawer();
    });

    // ==== Helpers ====
    const CORB = 'corbiolo';
    const now = new Date();

    const toDate = (d, t='00:00') => {
      if (!d) return new Date('Invalid');
      if (/^\d{4}-\d{2}-\d{2}/.test(d)) return new Date(d + 'T' + t);
      const m = d.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (m){ const dd=+m[1], mm=+m[2]-1, yy=(+m[3]<100?2000+ +m[3]:+m[3]); return new Date(yy,mm,dd); }
      return new Date(d + 'T' + t);
    };
    const fmtDT = (d) => d.toLocaleString(undefined,{weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
    const fmtD  = (d) => d.toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short'});

    function logoFor(name, provided){
      if ((name||'').trim().toLowerCase() === CORB) return 'img/logo_c5.png';
      if (provided) return provided;
      return 'img/logo_avv.png';
    }

    // ==== Dati ====
    document.getElementById('ls').textContent = last();

    const raw = (get('matches') || []);
    const matches = raw.map(m => ({
      ...m,
      date: toDate(m.data || '', m.ora || '00:00'),
      casa: (m.casa||'').trim(),
      fuori:(m.fuori||'').trim(),
      logo_casa: (m.logo_casa||'').trim(),
      logo_avv:  (m.logo_avv||m.logo_fuori||'').trim(),
      luogo: (m.luogo||m.campo||'').trim()
    })).filter(m => !isNaN(+m.date));

    const future = matches.filter(m => m.date > now).sort((a,b)=> a.date - b.date);

    // ==== Prossima partita (prima futura) ====
    const next = future[0];
    const nextGrid = document.getElementById('nextGrid');
    const nextMeta = document.getElementById('nextMeta');
    const nextBox  = document.getElementById('nextBox');

    if (!next){
      nextGrid.innerHTML = `<div class="small">Nessuna gara in programma</div>`;
      nextMeta.innerHTML = '';
    } else {
      const homeSide = (next.casa||'').toLowerCase() === CORB;
      const leftTeam   = homeSide ? next.casa  : next.fuori;
      const rightTeam  = homeSide ? next.fuori : next.casa;
      const leftLogo   = homeSide ? logoFor(next.casa, next.logo_casa) : logoFor(next.fuori, next.logo_avv);
      const rightLogo  = homeSide ? logoFor(next.fuori, next.logo_avv) : logoFor(next.casa, next.logo_casa);
      const icon       = homeSide ? 'üè†' : '‚úàÔ∏è';

      nextGrid.innerHTML = `
        <div style="text-align:center">
          <img class="logo" src="${leftLogo}" alt="">
          <div class="teamname" style="margin-top:6px">${leftTeam}</div>
        </div>
        <div class="scorebox">vs</div>
        <div style="text-align:center">
          <img class="logo" src="${rightLogo}" alt="">
          <div class="teamname" style="margin-top:6px">${rightTeam}</div>
        </div>
      `;

      const dateStr = fmtDT(next.date);
      const venue   = homeSide ? 'Casa' : 'Trasferta';
      nextMeta.innerHTML = `
        <span class="pill">${icon} ${venue}</span>
        <span class="pill">${dateStr}</span>
        ${next.luogo ? `<span class="pill">üìç ${next.luogo}</span>` : ``}
      `;
    }

    // ==== Lista tutte le future ====
    const list = document.getElementById('futureList');
    function row(m){
      const homeSide = (m.casa||'').toLowerCase() === CORB;
      const s1 = homeSide ? 'Corbiolo' : (m.casa||'');
      const s2 = homeSide ? (m.fuori||'') : 'Corbiolo';
      const when = fmtD(m.date);
      const icon = homeSide ? 'üè†' : '‚úàÔ∏è';
      const leftLogo  = homeSide ? logoFor(m.casa, m.logo_casa) : logoFor(m.fuori, m.logo_avv);
      const rightLogo = homeSide ? logoFor(m.fuori, m.logo_avv) : logoFor(m.casa, m.logo_casa);
      return `
        <div class="future-row">
          <div class="row">
            <img src="${leftLogo}" alt="" style="width:34px;height:34px;border-radius:8px;object-fit:cover">
            <div>
              <div style="font-weight:700">${s1} - ${s2}</div>
              <div class="small">${when}</div>
            </div>
          </div>
          <span class="pill">${icon} ${homeSide?'Casa':'Trasferta'}</span>
        </div>
      `;
    }
    list.innerHTML = future.length ? future.map(row).join('') : '<div class="small">Nessuna partita in programma</div>';

    // SW
    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>

  <!-- JS menu comune -->
  <script src="./ui.js?v=33"></script>
</body>
</html>
