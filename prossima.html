<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Prossima partita - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/logo_c5.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css?v=33">
  <style>
    .next-card{
      background:linear-gradient(180deg,#7d2631,#6b0f1a);
      color:#fff;border-radius:18px;padding:16px;
      box-shadow:0 10px 26px rgba(0,0,0,.14)
    }
    .versus{display:grid;grid-template-columns:1fr auto 1fr;gap:14px;align-items:center;margin-top:8px}
    .teamBox{display:flex;flex-direction:column;align-items:center;text-align:center}
    .teamLogo{width:72px;height:72px;border-radius:14px;object-fit:contain;background:#ffffff18}
    .vsBadge{padding:16px 18px;border-radius:16px;background:#ffffff20;font-weight:900}
    .metaRow{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    .pill-soft{background:#ffffff22;border:1px solid #ffffff44;color:#fff;border-radius:999px;padding:6px 12px;font-weight:600;font-size:12px}
    .future-row{display:grid;grid-template-columns:auto 1fr auto 1fr;gap:10px;align-items:center;padding:12px 0;border-bottom:1px solid var(--ring)}
    .future-row:last-child{border-bottom:0}
    .tinyLogo{width:34px;height:34px;border-radius:10px;object-fit:contain}
    .teamName{font-weight:700}
    .when{grid-column:1/-1;color:var(--muted);font-size:13px;margin-top:6px}
    .goCal{background:#ffffff25;border:1px solid #ffffff55;color:#fff;border-radius:999px;padding:6px 12px;font-weight:700;font-size:12px}
  </style>
</head>
<body>
  <header class="topbar">
    <div class="nav">
      <a href="./index.html" class="brand">
        <img src="img/logo_c5.png" alt="" class="brand-logo">
        <span class="title">Prossima partita</span>
      </a>
    </div>
    <div class="right">
      <button id="menuBtn" class="iconbtn" aria-label="Menu" title="Menu">
        <svg width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="#fff" stroke-width="2" stroke-linecap="round">
          <path d="M3 6h18M3 12h18M3 18h18"/>
        </svg>
      </button>
    </div>
  </header>

  <nav id="drawer" class="drawer">
    <button id="drawer-close" class="drawer-close" aria-label="Chiudi">‚úï</button>
    <h3>Menu</h3>
    <a href="./index.html">üè† Home</a>
    <a href="./news.html">üì∞ News</a>
    <a href="./squadra.html">üë• Squadra</a>
    <a href="./video.html">üé• Video</a>
    <a href="./prossima.html">üìÖ Prossima partita</a>
    <a href="./partite.html">üèÜ Risultati</a>
    <a href="./calendario.html">üìÜ Calendario</a>
    <a href="./admin.html">‚öôÔ∏è Admin</a>
  </nav>

  <main class="container">
    <section class="next-card">
      <div class="row" style="justify-content:space-between;align-items:center">
        <h2 style="margin:0">La prossima</h2>
        <a class="goCal" href="./calendario.html">Vedi calendario</a>
      </div>

      <div id="nextBlock" class="versus" style="margin-top:10px"></div>

      <div id="nextMeta" class="metaRow"></div>
    </section>

    <section class="card" style="margin-top:14px">
      <h2 style="margin:0 0 8px 0">Partite future</h2>
      <div id="futureList"></div>
    </section>

    <section class="card small" style="margin-top:14px">
      Ultimo aggiornamento dati: <span id="ls">never</span>
    </section>
  </main>

  <script type="module">
    import {get,last} from './data-store.js';

    /* Drawer */
    const drawer = document.getElementById('drawer');
    document.getElementById('menuBtn').onclick = (e)=>{e.stopPropagation();drawer.classList.add('open')};
    document.getElementById('drawer-close').onclick = ()=> drawer.classList.remove('open');
    document.addEventListener('click', (e)=>{ if(drawer.classList.contains('open') && !drawer.contains(e.target)) drawer.classList.remove('open') });

    document.getElementById('ls').textContent = last();

    const CORB = 'corbiolo';
    const LOGO_CORB = 'img/logo_c5.png';
    const LOGO_AVV  = 'img/logo_avv.png';

    const toDate = (m)=>{
      const dt = new Date((m.data||'')+'T'+(m.ora||'00:00'));
      return isNaN(+dt) ? new Date(m.data||'') : dt;
    };
    const fmtLong = (d)=> d.toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'long'}) + ' ¬∑ ' + d.toLocaleTimeString(undefined,{hour:'2-digit',minute:'2-digit'});

    const matches = (get('matches')||[]).map(m=>({...m, date:toDate(m)})).filter(m=>!isNaN(+m.date));
    const now = new Date();
    const future = matches.filter(m=> m.date > now).sort((a,b)=> a.date - b.date);

    /* ========== La prossima ========== */
    const next = future[0];
    const nextBlock = document.getElementById('nextBlock');
    const nextMeta  = document.getElementById('nextMeta');

    if(next){
      const homeName = (next.casa||'Corbiolo').trim();
      const awayName = (next.fuori||'Avversario').trim();
      const homeLogo = homeName.toLowerCase()===CORB ? LOGO_CORB : (next.logo_casa || LOGO_AVV);
      const awayLogo = awayName.toLowerCase()===CORB ? LOGO_CORB : (next.logo_fuori || LOGO_AVV);

      nextBlock.innerHTML = `
        <div class="teamBox">
          <img class="teamLogo" src="${homeLogo}" onerror="this.src='${LOGO_AVV}'" alt="">
          <div style="font-weight:800;margin-top:8px">${homeName}</div>
        </div>
        <div class="vsBadge">VS</div>
        <div class="teamBox">
          <img class="teamLogo" src="${awayLogo}" onerror="this.src='${LOGO_AVV}'" alt="">
          <div style="font-weight:800;margin-top:8px">${awayName}</div>
        </div>`;

      const isHomeCorb = homeName.toLowerCase()===CORB;
      nextMeta.innerHTML = `
        <span class="pill-soft">${isHomeCorb?'üè† Casa':'‚úàÔ∏è Trasferta'}</span>
        <span class="pill-soft">${fmtLong(next.date)}</span>
      `;
    } else {
      nextBlock.innerHTML = `<div class="small" style="grid-column:1/-1">Nessuna partita in programma</div>`;
      nextMeta.innerHTML = '';
    }

    /* ========== Partite future (lista, con loghi) ========== */
    const fWrap = document.getElementById('futureList');
    fWrap.innerHTML = future.length ? future.map(m=>{
      const homeName = (m.casa||'Corbiolo').trim();
      const awayName = (m.fuori||'Avversario').trim();
      const homeLogo = homeName.toLowerCase()===CORB ? LOGO_CORB : (m.logo_casa || LOGO_AVV);
      const awayLogo = awayName.toLowerCase()===CORB ? LOGO_CORB : (m.logo_fuori || LOGO_AVV);

      return `
        <div class="future-row">
          <img class="tinyLogo" src="${homeLogo}" onerror="this.src='${LOGO_AVV}'" alt="">
          <div class="teamName">${homeName}</div>
          <img class="tinyLogo" src="${awayLogo}" onerror="this.src='${LOGO_AVV}'" alt="">
          <div class="teamName">${awayName}</div>
          <div class="when">${fmtLong(m.date)}</div>
        </div>`;
    }).join('') : '<div class="small">Nessuna partita futura</div>';

    if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js');
  </script>
</body>
</html>
