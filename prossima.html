<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prossima partita - CORB</title>
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6b0f1a">
  <link rel="apple-touch-icon" href="img/icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="./style.css">
  <style>
    .future-row{display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--ring)}
    .future-row:last-child{border-bottom:0}
    .home-pill{background:#f3e8eb;border:1px solid #e4cbd3;color:#6b0f1a}
    .away-pill{background:rgba(14,165,233,.12);border:1px solid rgba(14,165,233,.35);color:#0ea5e9}
    /* Drawer (menu a tendina) */
    #drawer{position:fixed;top:0;right:-260px;width:240px;height:100%;background:#fff;
      box-shadow:-3px 0 12px rgba(0,0,0,.2);transition:.3s;padding:20px;z-index:50}
    #drawer.open{right:0}
    #drawer a{display:block;padding:12px 0;border-bottom:1px solid var(--ring);color:var(--text)}
    #drawer-close{position:absolute;top:12px;right:12px;font-size:20px;cursor:pointer}
  </style>
</head>
<body>
 <!-- Topbar -->
<header class="topbar">
  <div class="nav">
    <a href="./index.html" class="brand">
      <img src="img/logo_c5.png" alt="Corbiolo" class="brand-logo">
      <span class="title">Risultati</span>
    </a>
  </div>
  <div class="right">
    <button data-role="menu-btn" class="iconbtn" aria-label="Menu" title="Menu">
      <!-- hamburger (solo 3 linee) -->
      <svg width="26" height="26" viewBox="0 0 24 24" fill="none"
           stroke="#ffffff" stroke-width="2" stroke-linecap="round">
        <path d="M3 6h18M3 12h18M3 18h18"/>
      </svg>
    </button>
  </div>
</header>

<!-- Drawer menu (uguale per tutte le pagine) -->
<nav class="drawer" data-role="drawer">
  <button class="drawer-close" data-role="drawer-close" aria-label="Chiudi">‚úï</button>
  <h3>Menu</h3>
  <a href="./index.html">üè† Home</a>
  <a href="./news.html">üì∞ News</a>
  <a href="./squadra.html">üë• Squadra</a>
  <a href="./video.html">üé• Video</a>
  <a href="./prossima.html">üìÖ Prossima partita</a>
  <a href="./partite.html">üèÜ Risultati</a>
  <a href="./calendario.html">üìÜ Calendario</a>
  <a href="./admin.html">‚öôÔ∏è Admin</a>
</nav>


  <main class="container">
    <!-- Card prossima partita -->
    <section class="card" style="background:linear-gradient(180deg,#7d2631,#6b0f1a);color:#fff">
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:12px;align-items:center">
        <div style="text-align:center">
          <div style="width:64px;height:64px;border-radius:12px;background:#fff;margin:0 auto"></div>
          <div id="squadra1">‚Äî</div>
        </div>
        <div class="pill" style="background:#0001;border-color:#fff2;color:#fff">VS</div>
        <div style="text-align:center">
          <div style="width:64px;height:64px;border-radius:12px;background:#fff;margin:0 auto"></div>
          <div id="squadra2">‚Äî</div>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <span>üìÖ <span id="when"></span></span> ¬∑ <span>üìç <span id="place"></span></span>
      </div>
    </section>

    <!-- Countdown -->
    <section class="card">
      <div class="row" style="justify-content:space-between">
        <h2 class="small">Tempo rimanente</h2>
      </div>
      <div class="row" id="cd"></div>
      <div class="row" style="margin-top:10px">
        <a class="iconbtn" id="ics">üóì</a><span class="small">Aggiungi al calendario</span>
      </div>
    </section>

    <!-- Elenco partite future -->
    <section class="card">
      <h2 style="margin:0 0 8px 0">Prossime partite</h2>
      <div id="futureList"></div>
    </section>
  </main>

  <script type="module">
    import {get} from './data-store.js';

    // Drawer
    const drawer = document.getElementById('drawer');
    document.getElementById('menuBtn').onclick = () => drawer.classList.add('open');
    document.getElementById('drawer-close').onclick = () => drawer.classList.remove('open');

    // Helpers
    function toDate(d, t='00:00') {
      if (!d) return new Date('Invalid');
      if (/^\d{4}-\d{2}-\d{2}$/.test(d)) return new Date(`${d}T${t}`);
      const m = d.match(/^(\d{1,2})[\/\-\.](\d{1,2})[\/\-\.](\d{2,4})$/);
      if (m) {
        const dd = +m[1], mm = +m[2]-1, yy = (+m[3] < 100 ? 2000 + +m[3] : +m[3]);
        const [hh='00', mi='00'] = (t||'00:00').split(':');
        return new Date(yy, mm, dd, +hh||0, +mi||0);
      }
      return new Date(`${d}T${t}`);
    }
    function pad(n){return n.toString().padStart(2,'0');}
    const isHome = m => (m.casa || '').trim().toLowerCase() === 'corbiolo';

    const all = (get('matches') || []).map(m => ({
      ...m, date: toDate(m.data, m.ora), competizione: m.competizione || ''
    })).filter(m => !isNaN(+m.date));

    const now = new Date();
    const futures = all.filter(m => m.date > now).sort((a,b)=> a.date - b.date);
    const next = futures[0] || all.sort((a,b)=> a.date - b.date)[0] || null;

    // ===== PROSSIMA PARTITA =====
    if (next) {
      const homeSide = isHome(next);
      const squadra1 = homeSide ? 'Corbiolo' : (next.casa || 'Avversario');
      const squadra2 = homeSide ? (next.fuori || 'Avversario') : 'Corbiolo';

      document.getElementById('squadra1').textContent = squadra1;
      document.getElementById('squadra2').textContent = squadra2;
      document.getElementById('when').textContent =
        next.date.toLocaleDateString(undefined, {day:'2-digit',month:'long',year:'numeric'}) +
        ' ¬∑ ' +
        next.date.toLocaleTimeString(undefined, {hour:'2-digit',minute:'2-digit'});
      document.getElementById('place').textContent = next.luogo || '‚Äî';

      // Countdown
      const cd = document.getElementById('cd');
      const tick = () => {
        const now2 = new Date();
        let secs = Math.max(0, Math.floor((next.date - now2) / 1000));
        const d = Math.floor(secs / 86400); secs -= d*86400;
        const h = Math.floor(secs / 3600); secs -= h*3600;
        const m = Math.floor(secs / 60); const s = secs - m*60;
        cd.innerHTML = ['GIORNI','ORE','MIN','SEC'].map((lab,i)=>{
          const val = [d,h,m,s][i];
          return `<div class="card" style="text-align:center">
                    <div style="font-weight:800;font-size:22px">${pad(val)}</div>
                    <div class="small">${lab}</div>
                  </div>`;
        }).join('');
      };
      tick(); setInterval(tick, 1000);

      // ICS
      document.getElementById('ics').addEventListener('click', e => {
        e.preventDefault();
        const start = next.date;
        const end = new Date(start.getTime() + 90*60000);
        const ics = `BEGIN:VCALENDAR
VERSION:2.0
BEGIN:VEVENT
SUMMARY:${squadra1} vs ${squadra2}
DTSTART:${start.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'}
DTEND:${end.toISOString().replace(/[-:]/g,'').split('.')[0]+'Z'}
LOCATION:${(next.luogo||'')}
END:VEVENT
END:VCALENDAR`;
        const blob = new Blob([ics], {type:'text/calendar'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = 'prossima-partita.ics';
        a.click();
      });
    }

    // ===== ELENCO FUTURE =====
    const listEl = document.getElementById('futureList');
    function row(m){
      const homeSide = isHome(m);
      const squadra1 = homeSide ? 'Corbiolo' : (m.casa || 'Avversario');
      const squadra2 = homeSide ? (m.fuori || 'Avversario') : 'Corbiolo';
      const icon = homeSide ? 'üè†' : '‚úàÔ∏è';
      const pillClass = homeSide ? 'home-pill' : 'away-pill';
      const ds = m.date.toLocaleDateString(undefined,{weekday:'short', day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
      const label = `${squadra1} - ${squadra2}`;
      return `
        <div class="future-row">
          <div class="row">
            <span class="pill ${pillClass}">${icon}</span>
            <div>
              <div><strong>${label}</strong></div>
              <div class="small">${ds}</div>
            </div>
          </div>
          ${m.competizione ? `<span class="small">${m.competizione}</span>` : ''}
        </div>`;
    }
    listEl.innerHTML = futures.length
      ? futures.map(row).join('')
      : '<div class="small">Nessuna partita in programma</div>';

    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js');
    }
  </script>
</body>
</html>
